<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>field</title>
<meta name="theme-color" content="#071516" />

<style>
:root{
  --bg1:#071516;
  --bg2:#0e2423;

  --card1:rgba(14,40,40,0.92);
  --card2:rgba(5,20,20,0.92);

  --mint:#7ef5b5;
  --mint2:#9fffcf;

  --header:#e6f1ee;
  --soft:rgba(230,241,238,0.70);

  --circleText:#063a2b;
  --shadow: rgba(0,0,0,0.55);

  --breathDur: 11s;
}

*{ box-sizing:border-box; margin:0; padding:0; }

body{
  min-height:100vh;
  background:
    radial-gradient(circle at top, #143332, var(--bg1)),
    linear-gradient(var(--bg1), var(--bg2));
  display:flex;
  justify-content:center;
  align-items:center;
  color:var(--header);
  font-family: Georgia, "Times New Roman", serif;
}

.wrapper{
  width:100%;
  max-width:440px;
  padding: 36px 18px 56px;
  text-align:center;
  position:relative;
}

.lang-toggle{
  position:absolute;
  top:10px;
  right:14px;
  font-size:12px;
  letter-spacing:0.12em;
  opacity:0.75;
  user-select:none;
}
.lang-toggle span{ cursor:pointer; }
.lang-toggle span.active{ opacity:1; text-decoration: underline; text-underline-offset: 4px; }

/* Header wordmark constrained to circle width */
.header{
  width: 210px;
  margin: 0 auto 28px;
  display:flex;
  justify-content:space-between;
  align-items:baseline;
  font-weight:400;
  font-size: 3.55rem;
  letter-spacing: 0;
  color: var(--header);
  transition: opacity 900ms ease;
}
.header span{ display:inline-block; line-height:1; }

.header--phrase{
  width: auto;
  max-width: min(92vw, 520px);
  justify-content: center !important;
  gap: 0 !important;
  letter-spacing: 0.12em;
}
.header--phrase span{
  white-space: nowrap;
  font-size: clamp(32px, 7.0vw, 62px);
  line-height: 1;
}

/* card */
.card{
  background: linear-gradient(160deg, var(--card1), var(--card2));
  border-radius: 26px;
  padding: 34px 22px 32px;
  box-shadow: 0 30px 60px var(--shadow);
}

/* circle + ripple */
.circleWrap{
  position:relative;
  width:210px;
  height:210px;
  margin: 0 auto 18px;
}

.circle{
  width:210px;
  height:210px;
  border-radius:50%;
  background: radial-gradient(circle at 30% 30%, var(--mint2), var(--mint));
  display:flex;
  align-items:center;
  justify-content:center;
  font-family: Arial, system-ui, sans-serif;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  font-size: 0.72rem;
  color: var(--circleText);
  box-shadow: 0 0 52px rgba(126,245,181,0.52);
  cursor:pointer;
  user-select:none;
  transition: box-shadow 900ms ease, filter 900ms ease, opacity 420ms ease, transform 900ms ease;
  position: relative;
  overflow: hidden;
}

/* inner mist (subtle depth) */
.circle::before{
  content:"";
  position:absolute;
  inset:8%;
  border-radius:50%;
  background:
    radial-gradient(circle at 35% 35%,
      rgba(255,255,255,0.18),
      rgba(126,245,181,0.10),
      rgba(6,58,43,0.20)
    );
  filter: blur(2px);
  opacity: 0.85;
}

/* aura */
.circle::after{
  content:"";
  position:absolute;
  inset:-12%;
  border-radius:50%;
  background:
    radial-gradient(circle,
        rgba(126,245,181,0.26),
        rgba(126,245,181,0.10),
        rgba(0,0,0,0)
  );
  filter: blur(12px);
  opacity: 0.60;
}

/* breathing motion */
.circle.breathing{
  animation: breathe var(--breathDur) cubic-bezier(0.45,0.05,0.55,0.95) infinite;
}
@keyframes breathe{
  0%{ transform: scale(0.88); }
  50%{ transform: scale(1.00); }
  100%{ transform: scale(0.88); }
}

/* inhale/exhale phase tint (obvious but not flashy) */
.circle.phase-in{
  box-shadow: 0 0 66px rgba(126,245,181,0.62);
  filter: brightness(1.06) saturate(1.03);
}
.circle.phase-out{
  box-shadow: 0 0 44px rgba(126,245,181,0.38);
  filter: brightness(0.98) saturate(0.98);
}

/* subtle stillness */
.circle.still{
  animation:none !important;
  transform: scale(0.97);
  box-shadow: 0 0 40px rgba(126,245,181,0.34);
  filter: brightness(1.02);
}

/* label inside circle (inhale/exhale) */
.circleLabel{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  font-family: Arial, system-ui, sans-serif;
  letter-spacing: 0.18em;
  text-transform: uppercase;
  font-size: clamp(18px, 4.8vw, 22px);
  color: rgba(6,58,43,0.88);
  opacity: 0;
  transition: opacity 700ms ease;
  pointer-events:none;
}
.circleLabel.show{ opacity: 0.95; }

/* intention / koan */
.intent{
  color: var(--header);
  font-weight: 400;
  font-size: clamp(22px, 5.6vw, 30px);
  line-height: 1.15;
  margin: 16px 0 6px;
  user-select:none;
  transition: opacity 420ms ease;
}
.sub{
  font-size: clamp(14px, 3.6vw, 16px);
  color: var(--soft);
  margin-bottom: 18px;
  transition: opacity 420ms ease;
}

/* koan style */
.koan{
  color: rgba(230,241,238,0.92);
  font-weight: 400;
  font-size: clamp(18px, 4.9vw, 24px);
  line-height: 1.45;
  margin: 14px 0 6px;
  opacity: 0;
  transform: translateY(2px);
  transition: opacity 900ms ease, transform 900ms ease;
  min-height: 2.8em;
}
.koan.show{
  opacity: 0.75;
  transform: translateY(0);
}

/* fade intention during session */
.running .intent,
.running .sub{
  opacity: 0;
  pointer-events:none;
}

/* controls */
.controls{ display:flex; justify-content:center; margin-top: 6px; }
button{
  border:none;
  border-radius: 999px;
  padding: 12px 30px;
  font-size: 1rem;
  cursor:pointer;
  color: #063a2b;
  background: linear-gradient(135deg, #6deeb0, var(--mint));
  box-shadow: 0 6px 18px rgba(126,245,181,0.36);
  transition: transform 140ms ease, filter 140ms ease, opacity 140ms ease;
}
button:active{ transform: scale(0.99); }
button:hover{ filter: brightness(1.02); }

/* hide button during session (Field-style) */
.running #toggleBtn{
  opacity: 0;
  pointer-events:none;
}

/* small screens */
@media (max-width: 360px){
  .header{ width: 200px; font-size: 3.25rem; }
  .circleWrap,.circle{ width:200px; height:200px; }
}
@media (prefers-reduced-motion:reduce){
  .circle.breathing{ animation:none; }
}
</style>
</head>

<body>

<div class="wrapper" id="app">

  <div class="lang-toggle" id="langToggle" aria-label="language selector">
    <span id="enBtn">EN</span> · <span id="esBtn">ES</span>
  </div>

  <div class="header" id="header" aria-label="field wordmark"></div>

  <div class="card">
    <div class="circleWrap">
      <div class="circle" id="circle" aria-live="polite">
        <div class="circleLabel" id="circleLabel"></div>
        <span id="circleIdleText">FOLLOW THE CIRCLE</span>
      </div>
    </div>

    <div class="intent" id="intent">Equanimity and awareness</div>
    <div class="sub" id="sub">the field is shared.</div>

    <div class="koan" id="koan" aria-live="polite"></div>

    <div class="controls">
      <button id="toggleBtn" type="button">START</button>
    </div>
  </div>

</div>

<script>
(() => {
  'use strict';

  /* ───────── Text ───────── */
  let lang = localStorage.getItem('field_lang') || null;

  const TEXT = {
    en: {
      header: "field",
      follow: "FOLLOW THE CIRCLE",
      start: "START",
      stop: "STOP",
      inhale: "INHALE",
      exhale: "EXHALE",
      intent: "Equanimity and awareness",
      sub: "the field is shared.",
      exitLine: "carry this with you"
    },
    es: {
      header: "campo de presencia",
      follow: "SIGUE EL CÍRCULO",
      start: "COMENZAR",
      stop: "DETENER",
      inhale: "INHALA",
      exhale: "EXHALA",
      intent: "Calma y atención",
      sub: "el campo se comparte.",
      exitLine: "llévate esto contigo"
    }
  };

  /* Starter koans (we’ll expand to 100 later) */
  const KOANS = {
    en: [
      "What is aware of this breath?",
      "What if nothing is wrong?",
      "Where is the sense of me right now?",
      "What remains when you stop telling the story?",
      "Can this moment be enough?",
      "Who is experiencing this?",
      "What happens if you stop trying to fix it?",
      "What is already at ease?",
      "Is anything missing?",
      "What is here before thought?",
      "What if you didn’t need to know?",
      "Where does tension end and sensation begin?",
      "What relaxes when you stop pushing?",
      "What is quiet underneath the noise?",
      "What returns when you let everything be?",
      "Who would you be without the next thought?",
      "Where is the edge of the self right now?",
      "What if this is the path?",
      "Can you allow this exactly as it is?",
      "What is unchanged in this moment?",
      "What is holding you right now?",
      "What if you are already here?",
      "What does breathing breathe?",
      "What happens if you soften the eyes?",
      "What is simplest right now?",
      "What is true without words?",
      "Where does effort live in the body?",
      "What remains when effort drops?",
      "Who is looking?",
      "What if you trust the field?"
    ],
    es: [
      "¿Qué está notando esta respiración?",
      "¿Y si no hay nada que arreglar?",
      "¿Dónde aparece el yo ahora mismo?",
      "¿Qué queda cuando paras de contarte la historia?",
      "¿Y si esto fuera suficiente?",
      "¿Quién está viviendo esto?",
      "¿Qué pasa si dejas de querer arreglarlo?",
      "¿Qué ya está en calma?",
      "¿Falta algo ahora?",
      "¿Qué está aquí antes del pensamiento?",
      "¿Y si no necesitas saber?",
      "¿Dónde termina la tensión y empieza la sensación?",
      "¿Qué se suelta cuando dejas de empujar?",
      "¿Qué silencio hay debajo del ruido?",
      "¿Qué vuelve cuando lo dejas ser?",
      "¿Quién serías sin el próximo pensamiento?",
      "¿Dónde se siente el borde del yo ahora?",
      "¿Y si esto también es el camino?",
      "¿Puedes permitir esto tal como es?",
      "¿Qué no cambia en este momento?",
      "¿Qué te está sosteniendo ahora?",
      "¿Y si ya estás aquí?",
      "¿Qué respira cuando tú respiras?",
      "¿Qué pasa si suavizas la mirada?",
      "¿Qué es lo más simple ahora?",
      "¿Qué es verdad sin palabras?",
      "¿Dónde vive el esfuerzo en el cuerpo?",
      "¿Qué queda cuando el esfuerzo cae?",
      "¿Quién está mirando?",
      "¿Y si confías en el campo?"
    ]
  };

  /* ───────── Breath timing ───────── */
  // inhale slightly shorter than exhale
  const IN_SEC_BASE  = 5.0;
  const OUT_SEC_BASE = 5.8;

  function jitter(n){ return n + (Math.random()*0.6 - 0.3); } // ±0.3s
  function setBreathCSS(totalSec){
    document.documentElement.style.setProperty('--breathDur', totalSec.toFixed(2) + 's');
  }

  /* ───────── DOM ───────── */
  const app = document.getElementById('app');
  const header = document.getElementById('header');
  const circle = document.getElementById('circle');
  const circleIdleText = document.getElementById('circleIdleText');
  const circleLabel = document.getElementById('circleLabel');
  const intentEl = document.getElementById('intent');
  const subEl = document.getElementById('sub');
  const koanEl = document.getElementById('koan');
  const toggleBtn = document.getElementById('toggleBtn');

  const enBtn = document.getElementById('enBtn');
  const esBtn = document.getElementById('esBtn');

  /* Defensive */
  const REQUIRED = { app, header, circle, circleIdleText, circleLabel, intentEl, subEl, koanEl, toggleBtn, enBtn, esBtn };
  const missing = Object.entries(REQUIRED).filter(([,v]) => !v).map(([k]) => k);
  if (missing.length){
    console.error("field: missing DOM elements:", missing.join(", "));
    return;
  }

  /* ───────── Audio (ocean + bell) ───────── */
  let audioCtx = null;
  let oceanSource = null;
  let oceanGain = null;
  let oceanFilter = null;

  function ensureAudio(){
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // Ocean noise (pink-ish via filtering a white noise buffer)
    const bufferSize = 2 * audioCtx.sampleRate;
    const noiseBuffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const output = noiseBuffer.getChannelData(0);

    // White noise
    for (let i = 0; i < bufferSize; i++){
      output[i] = Math.random() * 2 - 1;
    }

    oceanSource = audioCtx.createBufferSource();
    oceanSource.buffer = noiseBuffer;
    oceanSource.loop = true;

    oceanFilter = audioCtx.createBiquadFilter();
    oceanFilter.type = "bandpass";
    oceanFilter.frequency.value = 220; // ocean-ish
    oceanFilter.Q.value = 0.7;

    const lowpass = audioCtx.createBiquadFilter();
    lowpass.type = "lowpass";
    lowpass.frequency.value = 900;

    oceanGain = audioCtx.createGain();
    oceanGain.gain.value = 0.0; // fade in on start

    oceanSource.connect(oceanFilter);
    oceanFilter.connect(lowpass);
    lowpass.connect(oceanGain);
    oceanGain.connect(audioCtx.destination);

    oceanSource.start(0);
  }

  function bell(){
    if (!audioCtx) return;
    const t0 = audioCtx.currentTime;

    const osc = audioCtx.createOscillator();
    osc.type = "sine";
    osc.frequency.setValueAtTime(784, t0);   // G5
    osc.frequency.exponentialRampToValueAtTime(523.25, t0 + 0.55); // C5

    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.0, t0);
    gain.gain.linearRampToValueAtTime(0.18, t0 + 0.02);
    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.75);

    // slight shimmer
    const osc2 = audioCtx.createOscillator();
    osc2.type = "triangle";
    osc2.frequency.setValueAtTime(1175, t0);
    const gain2 = audioCtx.createGain();
    gain2.gain.setValueAtTime(0.0, t0);
    gain2.gain.linearRampToValueAtTime(0.08, t0 + 0.03);
    gain2.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.62);

    osc.connect(gain);
    osc2.connect(gain2);
    gain.connect(audioCtx.destination);
    gain2.connect(audioCtx.destination);

    osc.start(t0);
    osc2.start(t0);
    osc.stop(t0 + 0.8);
    osc2.stop(t0 + 0.7);
  }

  function oceanFadeTo(target, seconds=1.2){
    if (!oceanGain || !audioCtx) return;
    const t0 = audioCtx.currentTime;
    oceanGain.gain.cancelScheduledValues(t0);
    oceanGain.gain.setValueAtTime(oceanGain.gain.value, t0);
    oceanGain.gain.linearRampToValueAtTime(target, t0 + seconds);
  }

  /* ───────── Header rendering ───────── */
  function renderHeaderWord(word){
    header.innerHTML = '';

    if (word.includes(' ')) {
      header.classList.add('header--phrase');
      const s = document.createElement('span');
      s.textContent = word;
      header.appendChild(s);
      return;
    }

    header.classList.remove('header--phrase');
    for (const ch of word){
      const s = document.createElement('span');
      s.textContent = ch;
      header.appendChild(s);
    }
  }

  /* ───────── Language ───────── */
  function setLanguage(l){
    lang = l;
    localStorage.setItem('field_lang', l);

    enBtn.classList.toggle('active', l === 'en');
    esBtn.classList.toggle('active', l === 'es');

    renderHeaderWord(TEXT[lang].header);
    circleIdleText.textContent = TEXT[lang].follow;
    toggleBtn.textContent = running ? TEXT[lang].stop : TEXT[lang].start;
    intentEl.textContent = TEXT[lang].intent;
    subEl.textContent = TEXT[lang].sub;

    if (!running){
      koanEl.textContent = '';
      koanEl.classList.remove('show');
    }
  }

  enBtn.addEventListener('click', () => setLanguage('en'));
  esBtn.addEventListener('click', () => setLanguage('es'));

  /* ───────── Session / Breath loop ───────── */
  let running = false;
  let phaseTimeoutA = null;
  let phaseTimeoutB = null;
  let stillTimeout = null;
  let guideTimeoutA = null;
  let guideTimeoutB = null;
  let guideTimeoutC = null;

  // Koan timers
  let koanTimeout = null;
  let koanInterval = null;
  let koans = [];
  let kIndex = 0;

  function clearTimers(){
    [phaseTimeoutA, phaseTimeoutB, stillTimeout, guideTimeoutA, guideTimeoutB, guideTimeoutC, koanTimeout].forEach(t => {
      if (t) clearTimeout(t);
    });
    phaseTimeoutA = phaseTimeoutB = stillTimeout = guideTimeoutA = guideTimeoutB = guideTimeoutC = koanTimeout = null;

    if (koanInterval){
      clearInterval(koanInterval);
      koanInterval = null;
    }
  }

  function setGlowPhase(phase){
    circle.classList.remove('phase-in','phase-out');
    circle.classList.add(phase === 'in' ? 'phase-in' : 'phase-out');
  }

  function startBreathCycle(){
    if (!running) return;

    // Organic durations (inhale/exhale)
    const inSec  = Math.max(4.4, jitter(IN_SEC_BASE));
    const outSec = Math.max(5.0, jitter(OUT_SEC_BASE));
    const total = inSec + outSec;
    setBreathCSS(total);

    circle.classList.remove('still');
    circle.classList.add('breathing');

    setGlowPhase('in');
    phaseTimeoutA = setTimeout(() => {
      setGlowPhase('out');
      phaseTimeoutB = setTimeout(() => {
        // Occasionally pause (stillness window)
        if (Math.random() < 0.22){
          enterStillness();
        } else {
          startBreathCycle();
        }
      }, outSec * 1000);
    }, inSec * 1000);
  }

  function enterStillness(){
    circle.classList.remove('breathing','phase-in','phase-out');
    circle.classList.add('still');
    stillTimeout = setTimeout(() => {
      if (running) startBreathCycle();
    }, 2200 + Math.random()*1200);
  }

  function startFirstCycleGuidance(){
    circleLabel.textContent = TEXT[lang].inhale;
    circleLabel.classList.add('show');

    guideTimeoutA = setTimeout(() => {
      circleLabel.textContent = TEXT[lang].exhale;
    }, 5200);

    guideTimeoutB = setTimeout(() => {
      circleLabel.classList.remove('show');
    }, 11200);

    guideTimeoutC = setTimeout(() => {
      circleLabel.textContent = '';
    }, 12500);
  }

  function initKoans(){
    koans = [...KOANS[lang]].sort(() => Math.random() - 0.5);
    kIndex = 0;
  }

  function showKoan(){
    if (!running || !koans.length) return;
    const q = koans[kIndex];
    kIndex = (kIndex + 1) % koans.length;

    koanEl.textContent = q;
    koanEl.classList.add('show');

    setTimeout(() => {
      koanEl.classList.remove('show');
    }, 10000);
  }

  function scheduleKoans(){
    // first koan ~ 25–35s
    const firstDelay = 25000 + Math.random()*10000;
    koanTimeout = setTimeout(() => {
      showKoan();

      // subsequent koans every 2.5–4 min (randomized each time)
      koanInterval = setInterval(() => {
        showKoan();
      }, 150000 + Math.random()*90000);
    }, firstDelay);
  }

  function startSession(){
    if (!lang) lang = 'en';
    setLanguage(lang);

    if (running) return;
    running = true;

    app.classList.add('running');

    // lock language selection during session (still visible, but inert)
    enBtn.style.pointerEvents = 'none';
    esBtn.style.pointerEvents = 'none';
    enBtn.style.opacity = '0.55';
    esBtn.style.opacity = '0.55';

    toggleBtn.textContent = TEXT[lang].stop;

    // audio: must be created on a user gesture
    ensureAudio();
    if (audioCtx.state === 'suspended') audioCtx.resume();
    bell();
    oceanFadeTo(0.07, 1.6); // subtle ocean bed

    circleIdleText.textContent = ''; // reduce text
    koanEl.textContent = '';
    koanEl.classList.remove('show');

    initKoans();
    startFirstCycleGuidance();
    startBreathCycle();
    scheduleKoans();
  }

  function stopSession(){
    running = false;
    app.classList.remove('running');
    clearTimers();

    // audio
    if (audioCtx){
      bell();
      oceanFadeTo(0.0, 1.4);
    }

    circle.classList.remove('breathing','phase-in','phase-out','still');
    circleLabel.classList.remove('show');
    circleLabel.textContent = '';

    // restore idle
    circleIdleText.textContent = TEXT[lang].follow;
    toggleBtn.textContent = TEXT[lang].start;

    koanEl.classList.remove('show');
    koanEl.textContent = '';

    // unlock language
    enBtn.style.pointerEvents = 'auto';
    esBtn.style.pointerEvents = 'auto';
    enBtn.style.opacity = '';
    esBtn.style.opacity = '';
  }

  function toggleSession(){
    running ? stopSession() : startSession();
  }

  toggleBtn.addEventListener('click', toggleSession);

  // Optional: tapping circle starts session if not running (after language chosen)
  circle.addEventListener('click', () => {
    if (!running){
      if (!lang) setLanguage('en');
      startSession();
    }
  });

  // Long-press circle stops (mobile-friendly)
  let pressTimer = null;
  const PRESS_MS = 650;

  function startPress(){
    if (!running) return;
    pressTimer = setTimeout(() => {
      stopSession();
    }, PRESS_MS);
  }
  function endPress(){
    if (pressTimer){
      clearTimeout(pressTimer);
      pressTimer = null;
    }
  }

  circle.addEventListener('touchstart', startPress, {passive:true});
  circle.addEventListener('touchend', endPress, {passive:true});
  circle.addEventListener('mousedown', startPress);
  circle.addEventListener('mouseup', endPress);
  circle.addEventListener('mouseleave', endPress);

  document.addEventListener('visibilitychange', () => {
    if (document.hidden && running) {
      // Pause timers; keep running state. Resume breath loop when visible.
      clearTimers();
    } else if (!document.hidden && running) {
      startBreathCycle();
      scheduleKoans();
    }
  });

  // Init: default language to saved or show EN active by default
  if (lang){
    setLanguage(lang);
  } else {
    // show default selection with EN active visually, without committing until click
    enBtn.classList.add('active');
    renderHeaderWord(TEXT.en.header);
    circleIdleText.textContent = TEXT.en.follow;
    toggleBtn.textContent = TEXT.en.start;
    intentEl.textContent = TEXT.en.intent;
    subEl.textContent = TEXT.en.sub;
  }

})();
</script>
</body>
</html>
