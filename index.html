<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Coherence</title>
<meta name="theme-color" content="#8fb9ff">

<style>
body {
  font-family: -apple-system, system-ui, Arial;
  margin: 24px;
  max-width: 860px;
  background: #f5f7fb;
  transition: background .3s, color .3s;
}

body.dark {
  background: #111;
  color: #eee;
}

.card {
  background: white;
  padding: 16px;
  border-radius: 12px;
  border: 1px solid #ddd;
  margin: 12px 0;
}

body.dark .card {
  background: #1c1c1c;
  border-color: #333;
}

.row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
}

button, select, input, textarea {
  padding: 10px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 16px;
}

button {
  cursor: pointer;
}

.big {
  font-size: 28px;
  font-weight: 700;
}

.pill {
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 999px;
}

#breathCircle {
  width: 150px;
  height: 150px;
  border-radius: 50%;
  margin: 20px auto;
  background: radial-gradient(circle at 30% 30%, #a9c7ff, #6fa0ff);
  transition: transform linear;
  box-shadow: 0 0 25px rgba(120,160,255,0.4);
}

body.dark #breathCircle {
  background: radial-gradient(circle at 30% 30%, #557cff, #334b99);
}
</style>
</head>

<body>

<h1>Coherence</h1>
<div class="muted">Reset ‚Ä¢ Steer ‚Ä¢ Reflect</div>

<div class="card">

<div id="breathCircle"></div>

<div class="row">

<select id="preset">
  <option value="calm">Calm (4‚Äì6)</option>
  <option value="focus">Focus (4‚Äì4)</option>
  <option value="sleep">Sleep (4‚Äì8)</option>
  <option value="energise">Energise (6‚Äì2)</option>
  <option value="custom">Custom</option>
</select>

<input id="inSec" type="number" value="4" style="width:80px;">
<input id="outSec" type="number" value="6" style="width:80px;">

<select id="duration">
  <option value="1">1m</option>
  <option value="3">3m</option>
  <option value="5" selected>5m</option>
  <option value="10">10m</option>
</select>

</div>

<div class="row" style="margin-top:12px;">

<button id="startStop">Start</button>

<span class="pill" id="phase">Ready</span>
<span class="pill" id="timer">00:00</span>

</div>

<div class="big" id="cue" style="margin-top:15px;">
Equanimity and awareness
</div>

<div class="row" style="margin-top:10px;">

<button id="newCue">New cue</button>
<button id="darkToggle">Dark mode</button>

</div>

<hr>

<div>
üåê Shared Field:
<span id="presenceCount">‚Äî</span>
</div>

</div>


<script>

/* ================================
   Cloudflare Worker URL
   ================================ */

const PRESENCE_BASE =
  "https://coherence-presence-2.lucolly999.workers.dev";


/* ================================ */

let running = false;
let startTime = 0;
let breathTimer = null;
let tick = null;
let phase = "Ready";
let sessionSec = 300;
let presenceId = null;

const CUES = [
  "Equanimity and awareness",
  "Steady",
  "Soft eyes",
  "Release",
  "Match this",
  "Joy",
  "Metta"
];

function haptic(type="light"){
  if (navigator.vibrate){
    navigator.vibrate(type==="strong" ? 40 : 15);
  }
}

function mmss(s){
  const m = Math.floor(s/60);
  const r = s % 60;
  return String(m).padStart(2,"0") + ":" + String(r).padStart(2,"0");
}


/* ===== Presence ===== */

function updatePresence(){
  fetch(PRESENCE_BASE + "/presence/count")
    .then(r => r.json())
    .then(j => {
      document.getElementById("presenceCount").textContent = j.count;
    })
    .catch(()=>{});
}

function joinPresence(){
  fetch(PRESENCE_BASE + "/presence/join")
    .then(r => r.json())
    .then(j => {
      presenceId = j.id;
      updatePresence();
    });
}

function leavePresence(){
  if (!presenceId) return;
  navigator.sendBeacon(
    PRESENCE_BASE + "/presence/leave?id=" + presenceId
  );
}


/* ===== Breathing ===== */

function scheduleBreath(){

  const inSec =
    parseInt(document.getElementById("inSec").value);

  const outSec =
    parseInt(document.getElementById("outSec").value);

  const circle =
    document.getElementById("breathCircle");

  if (phase==="Ready" || phase==="Out"){

    phase = "In";
    document.getElementById("phase").textContent = "Inhale";

    circle.style.transition =
      `transform ${inSec}s linear`;

    circle.style.transform = "scale(1.4)";

    haptic("light");

    breathTimer =
      setTimeout(scheduleBreath, inSec*1000);

  } else {

    phase = "Out";
    document.getElementById("phase").textContent = "Exhale";

    circle.style.transition =
      `transform ${outSec}s linear`;

    circle.style.transform = "scale(1)";

    haptic("strong");

    breathTimer =
      setTimeout(scheduleBreath, outSec*1000);
  }
}


/* ===== Session ===== */

function start(){

  if (running) return;

  running = true;
  startTime = Date.now();

  sessionSec =
    parseInt(document.getElementById("duration").value) * 60;

  scheduleBreath();

  tick = setInterval(()=>{

    const elapsed =
      Math.floor((Date.now()-startTime)/1000);

    document.getElementById("timer").textContent =
      mmss(elapsed);

    if (elapsed >= sessionSec){
      stop();
      bell();
    }

  }, 500);
}

function stop(){

  running = false;

  clearTimeout(breathTimer);
  clearInterval(tick);

  document.getElementById("phase").textContent = "Ready";
  document.getElementById("breathCircle").style.transform =
    "scale(1)";
}


/* ===== Bell ===== */

function bell(){

  const ctx =
    new (window.AudioContext||window.webkitAudioContext)();

  const o = ctx.createOscillator();
  const g = ctx.createGain();

  o.type = "sine";
  o.frequency.value = 432;

  o.connect(g);
  g.connect(ctx.destination);

  o.start();

  g.gain.exponentialRampToValueAtTime(
    0.0001,
    ctx.currentTime+1
  );

  o.stop(ctx.currentTime+1);
}


/* ===== UI ===== */

document.getElementById("startStop").onclick = ()=>{
  running ? stop() : start();
};

document.getElementById("newCue").onclick = ()=>{
  document.getElementById("cue").textContent =
    CUES[Math.floor(Math.random()*CUES.length)];
};

document.getElementById("preset").onchange = (e)=>{

  const v = e.target.value;

  if (v==="calm"){ inSec.value=4; outSec.value=6; }
  if (v==="focus"){ inSec.value=4; outSec.value=4; }
  if (v==="sleep"){ inSec.value=4; outSec.value=8; }
  if (v==="energise"){ inSec.value=6; outSec.value=2; }

};

document.getElementById("darkToggle").onclick = ()=>{
  document.body.classList.toggle("dark");
};


/* ===== Startup ===== */

joinPresence();
updatePresence();

setInterval(updatePresence, 10000);

window.addEventListener("beforeunload", leavePresence);

</script>
</body>
</html>
