<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Coherence</title>

<style>
:root{
  --bg:#f2f2f2;
  --card:#ffffff;
  --text:#111;
  --muted:#666;
  --accent:#4da3ff;
}

body.dark{
  --bg:#111;
  --card:#1c1c1c;
  --text:#f5f5f5;
  --muted:#aaa;
}

body{
  margin:0;
  font-family:-apple-system,system-ui,Segoe UI,Roboto;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:520px;
  margin:0 auto;
  padding:20px;
}

h1{margin:0}
.sub{color:var(--muted);margin-bottom:18px}

.card{
  background:var(--card);
  border-radius:18px;
  padding:20px;
  box-shadow:0 10px 25px rgba(0,0,0,.06);
}

.circleWrap{
  display:flex;
  justify-content:center;
  margin:20px 0;
}

.circle{
  width:200px;
  height:200px;
  border-radius:50%;
  transition:transform linear, background 0.5s;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
}

.row{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  align-items:center;
}

button, select, input{
  padding:10px;
  border-radius:10px;
  border:1px solid #ccc;
  font-size:16px;
}

button{
  cursor:pointer;
  background:#eaeaea;
}

button.primary{
  background:var(--accent);
  color:white;
  border:none;
}

.pill{
  padding:6px 12px;
  border-radius:999px;
  background:#eaeaea;
}

textarea{
  width:100%;
  padding:10px;
  border-radius:12px;
  margin-top:10px;
}

.logItem{
  margin-top:12px;
  padding:10px;
  background:#fafafa;
  border-radius:10px;
  font-size:14px;
}

body.dark .logItem{
  background:#2a2a2a;
}
</style>
</head>

<body>
<div class="container">
<h1>Coherence</h1>
<div class="sub">Reset ‚Ä¢ Steer ‚Ä¢ Reflect</div>

<div class="card">

<div class="circleWrap">
<div id="circle" class="circle"></div>
</div>

<div class="pill" id="explain">Choose a mode and press Start.</div>

<br><br>

<select id="preset"></select>

<div class="row">
<input id="inSec" type="number" value="4" min="1">
<input id="outSec" type="number" value="6" min="1">
<input id="holdSec" type="number" value="0" min="0">
</div>

<div class="row">
<input id="durationMin" type="number" value="1" min="1">
<span>minutes</span>
</div>

<br>

<div class="row">
<button id="startStop" class="primary">Start</button>
<span class="pill" id="phase">Ready</span>
<span class="pill" id="timer">00:00</span>
<span class="pill" id="fieldStatus">Field: ‚Äî</span>
</div>

<br>

<div id="cueLine" style="font-size:22px;font-weight:600;margin-top:10px;"></div>

<br>

<div class="row">
<button id="newCue">New cue</button>
<button id="darkToggle">Dark</button>
<button id="joinField">Join Field</button>
<button id="leaveField">Leave Field</button>
<span class="pill">üåê <span id="fieldCount">0</span></span>
</div>

<hr style="margin:20px 0">

<div>
<label>Gauge</label>
<input id="gauge" type="range" min="-5" max="5" value="0">
<span id="gaugeVal">0</span>
<span id="gaugeLabel">Neutral</span>
</div>

<textarea id="note" rows="3" placeholder="One line note..."></textarea>

<div class="row">
<button id="saveLog" class="primary">Log</button>
<button id="clearLog">Clear</button>
</div>

<div id="logContainer"></div>

</div>
</div>

<script>
const WORKER_URL = "https://coherence-presence-2.lucolly999.workers.dev";

const circle = document.getElementById("circle");
const presetSelect = document.getElementById("preset");
const explain = document.getElementById("explain");

const presets = [
{ name:"Focus (4‚Äì4)", in:4, out:4, hold:0,
  explain:"Equal breathing supports steady attention and calm focus." },
{ name:"Calm (4‚Äì6)", in:4, out:6, hold:0,
  explain:"Longer exhale signals safety and supports vagal tone." },
{ name:"Sleep (4‚Äì8)", in:4, out:8, hold:0,
  explain:"Long exhale slows heart rate and supports sleep." },
{ name:"Anxiety (3‚Äì6)", in:3, out:6, hold:0,
  explain:"Short inhale and long exhale reduce agitation." },
{ name:"Custom", in:4, out:6, hold:0,
  explain:"Adjust to match your state." }
];

presets.forEach((p,i)=>{
  const opt=document.createElement("option");
  opt.value=i;
  opt.textContent=p.name;
  presetSelect.appendChild(opt);
});

function applyPreset(i){
  const p=presets[i];
  document.getElementById("inSec").value=p.in;
  document.getElementById("outSec").value=p.out;
  document.getElementById("holdSec").value=p.hold;
  explain.innerHTML="<b>What this does:</b> "+p.explain;
}
presetSelect.onchange=e=>applyPreset(e.target.value);
applyPreset(0);

let running=false;
let interval;
let totalSeconds=0;
let elapsed=0;
let phase="in";
let colorIndex=0;
const colors=["#6fd3a8","#4da3ff","#b084f5","#ff9f7a","#ffd166"];
circle.style.background=colors[0];

circle.onclick=()=>{
  colorIndex=(colorIndex+1)%colors.length;
  circle.style.background=colors[colorIndex];
};

function vibrate(ms){
  if(navigator.vibrate) navigator.vibrate(ms);
}

function startBreathing(){
  const inSec=+inSecInput.value;
  const outSec=+outSecInput.value;
  const holdSec=+holdSecInput.value;
  const durationMin=+durationMinInput.value;

  totalSeconds=durationMin*60;
  elapsed=0;
  running=true;
  document.getElementById("startStop").textContent="Stop";

  function update(){
    if(!running) return;
    elapsed++;
    document.getElementById("timer").textContent=
      String(Math.floor((totalSeconds-elapsed)/60)).padStart(2,"0")
      +":"+String((totalSeconds-elapsed)%60).padStart(2,"0");

    if(elapsed>=totalSeconds){
      stopBreathing();
      return;
    }
  }

  function cycle(){
    if(!running) return;

    const inSec=+inSecInput.value;
    const outSec=+outSecInput.value;
    const holdSec=+holdSecInput.value;

    document.getElementById("phase").textContent="Inhale";
    circle.style.transitionDuration=inSec+"s";
    circle.style.transform="scale(1.3)";
    vibrate(10);

    setTimeout(()=>{
      if(holdSec>0){
        document.getElementById("phase").textContent="Hold";
        vibrate(5);
      }
    },inSec*1000);

    setTimeout(()=>{
      document.getElementById("phase").textContent="Exhale";
      circle.style.transitionDuration=outSec+"s";
      circle.style.transform="scale(1)";
      vibrate(15);
    },(inSec+holdSec)*1000);

    setTimeout(cycle,(inSec+holdSec+outSec)*1000);
  }

  interval=setInterval(update,1000);
  cycle();
}

function stopBreathing(){
  running=false;
  clearInterval(interval);
  document.getElementById("startStop").textContent="Start";
  document.getElementById("phase").textContent="Ready";
}

document.getElementById("startStop").onclick=()=>{
  running?stopBreathing():startBreathing();
};

const inSecInput=document.getElementById("inSec");
const outSecInput=document.getElementById("outSec");
const holdSecInput=document.getElementById("holdSec");
const durationMinInput=document.getElementById("durationMin");

document.getElementById("darkToggle").onclick=()=>{
  document.body.classList.toggle("dark");
};

document.getElementById("gauge").oninput=e=>{
  const v=e.target.value;
  document.getElementById("gaugeVal").textContent=v;
  document.getElementById("gaugeLabel").textContent=
    v>2?"Open":v<-2?"Tight":"Neutral";
};

document.getElementById("newCue").onclick=()=>{
  const cues=["Steady","Gentle","Soft eyes","Match this","Equanimity"];
  document.getElementById("cueLine").textContent=
    cues[Math.floor(Math.random()*cues.length)];
};

function renderLogs(){
  const logs=JSON.parse(localStorage.getItem("coh_logs")||"[]");
  const container=document.getElementById("logContainer");
  container.innerHTML="";
  logs.forEach(l=>{
    const div=document.createElement("div");
    div.className="logItem";
    div.innerHTML=`${l.time}<br><b>${l.note}</b> (gauge ${l.gauge})`;
    container.appendChild(div);
  });
}
renderLogs();

document.getElementById("saveLog").onclick=()=>{
  const logs=JSON.parse(localStorage.getItem("coh_logs")||"[]");
  logs.unshift({
    time:new Date().toLocaleString(),
    note:document.getElementById("note").value,
    gauge:document.getElementById("gauge").value
  });
  localStorage.setItem("coh_logs",JSON.stringify(logs));
  document.getElementById("note").value="";
  renderLogs();
};

document.getElementById("clearLog").onclick=()=>{
  localStorage.removeItem("coh_logs");
  renderLogs();
};

async function joinField(){
  const r=await fetch(WORKER_URL+"/join");
  const j=await r.json();
  document.getElementById("fieldStatus").textContent="Field: joined";
  document.getElementById("fieldCount").textContent=j.count;
}

async function leaveField(){
  const r=await fetch(WORKER_URL+"/leave");
  const j=await r.json();
  document.getElementById("fieldStatus").textContent="Field: left";
  document.getElementById("fieldCount").textContent=j.count||0;
}

async function pollField(){
  try{
    const r=await fetch(WORKER_URL+"/count");
    const j=await r.json();
    document.getElementById("fieldCount").textContent=j.count||0;
  }catch{}
}
setInterval(pollField,4000);

document.getElementById("joinField").onclick=joinField;
document.getElementById("leaveField").onclick=leaveField;
</script>
</body>
</html>
