<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Coherence</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%2378f0b1'/></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
  <meta name="theme-color" content="#0d1117">

  <style>
    /* â”€â”€â”€ TOKENS â”€â”€â”€ */
    :root {
      --bg: #0d1117;
      --surface: #131920;
      --surface2: #1a2332;
      --border: rgba(255,255,255,.07);
      --border-hover: rgba(255,255,255,.15);
      --text: #e8edf3;
      --text-dim: #6b7c94;
      --text-muted: #3d4f63;
      --accent: #78f0b1;
      --accent-dim: rgba(120,240,177,.12);
      --accent-glow: rgba(120,240,177,.3);
      --warm: #ffd36b;
      --rose: #ff8ec5;
      --violet: #b493ff;
      --sky: #7ab8ff;
      --font-display: 'DM Serif Display', Georgia, serif;
      --font-body: 'DM Sans', system-ui, sans-serif;
      --r: 20px;
      --r-sm: 12px;
    }
    .light {
      --bg: #f0f4f8;
      --surface: #ffffff;
      --surface2: #e8eef5;
      --border: rgba(0,0,0,.07);
      --border-hover: rgba(0,0,0,.15);
      --text: #0d1117;
      --text-dim: #4a5e72;
      --text-muted: #a0b4c8;
      --accent: #1a9e6c;
      --accent-dim: rgba(26,158,108,.1);
      --accent-glow: rgba(26,158,108,.25);
    }

    /* â”€â”€â”€ RESET â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: var(--font-body);
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      font-size: 15px;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }

    /* â”€â”€â”€ BACKGROUND GLOW â”€â”€â”€ */
    body::before {
      content: '';
      position: fixed;
      top: -30%;
      left: 50%;
      transform: translateX(-50%);
      width: 80vw;
      height: 60vw;
      background: radial-gradient(ellipse, rgba(120,240,177,.04) 0%, transparent 70%);
      pointer-events: none;
      z-index: 0;
    }

    /* â”€â”€â”€ LAYOUT â”€â”€â”€ */
    .page {
      position: relative;
      z-index: 1;
      max-width: 520px;
      margin: 0 auto;
      padding: 32px 20px 60px;
    }

    /* â”€â”€â”€ HEADER â”€â”€â”€ */
    .header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 32px;
    }
    .logo {
      font-family: var(--font-display);
      font-size: 36px;
      letter-spacing: -.5px;
      color: var(--text);
    }
    .logo em {
      font-style: italic;
      color: var(--accent);
    }
    .tagline {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--text-muted);
    }
    .theme-toggle {
      background: none;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 14px;
      font-size: 12px;
      font-family: var(--font-body);
      color: var(--text-dim);
      cursor: pointer;
      transition: all .2s;
    }
    .theme-toggle:hover {
      border-color: var(--border-hover);
      color: var(--text);
    }

    /* â”€â”€â”€ CARDS â”€â”€â”€ */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--r);
      padding: 24px;
      margin-bottom: 12px;
    }
    .card-title {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: .12em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    /* â”€â”€â”€ BREATHING CIRCLE â”€â”€â”€ */
    .breath-card {
      text-align: center;
      padding: 32px 24px;
      overflow: hidden;
      position: relative;
    }
    .circle-wrap {
      position: relative;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 24px;
    }
    .circle-ring {
      position: absolute;
      width: 220px;
      height: 220px;
      border-radius: 50%;
      border: 1px solid var(--accent-dim);
      animation: ring-pulse 4s ease-in-out infinite;
    }
    .circle-ring:nth-child(2) {
      width: 200px; height: 200px;
      border-color: rgba(120,240,177,.06);
      animation-delay: .5s;
    }
    @keyframes ring-pulse {
      0%, 100% { transform: scale(1); opacity: .5; }
      50% { transform: scale(1.04); opacity: 1; }
    }
    .circle {
      position: relative;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 30%,
        rgba(255,255,255,.2) 0%,
        rgba(255,255,255,.0) 50%),
        var(--c, #78f0b1);
      box-shadow:
        0 0 60px var(--cg, rgba(120,240,177,.25)),
        inset 0 1px 0 rgba(255,255,255,.3);
      transition:
        transform 800ms cubic-bezier(.4,0,.2,1),
        filter 600ms ease,
        --c 400ms ease,
        --cg 400ms ease;
      cursor: pointer;
      user-select: none;
      z-index: 1;
    }
    .circle.inhale  { transform: scale(1.15); filter: brightness(1.1); }
    .circle.hold    { transform: scale(1.15); filter: brightness(1.05) saturate(1.2); }
    .circle.exhale  { transform: scale(.85);  filter: brightness(.95); }
    .circle.idle    { transform: scale(1);    filter: brightness(1); }

    .phase-label {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: var(--font-body);
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: rgba(10,20,15,.7);
      pointer-events: none;
    }
    .phase-countdown {
      font-family: var(--font-display);
      font-size: 26px;
      letter-spacing: -.5px;
      color: rgba(10,20,15,.8);
      line-height: 1;
    }

    .status-row {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 5px 12px;
      border-radius: 999px;
      background: var(--surface2);
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-dim);
    }
    .pill.active {
      background: var(--accent-dim);
      border-color: rgba(120,240,177,.2);
      color: var(--accent);
    }
    .pill .dot {
      width: 6px; height: 6px;
      border-radius: 50%;
      background: currentColor;
    }

    .btn-start {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--accent);
      color: #0a180f;
      border: none;
      border-radius: 999px;
      padding: 12px 32px;
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
      box-shadow: 0 4px 20px var(--accent-glow);
    }
    .btn-start:hover { transform: translateY(-1px); box-shadow: 0 6px 24px var(--accent-glow); }
    .btn-start:active { transform: translateY(0); }
    .btn-start.running {
      background: var(--surface2);
      color: var(--text-dim);
      box-shadow: none;
    }
    .btn-start svg { transition: transform .3s; }
    .btn-start:hover svg { transform: scale(1.1); }

    .what-banner {
      background: var(--accent-dim);
      border: 1px solid rgba(120,240,177,.12);
      border-radius: var(--r-sm);
      padding: 10px 14px;
      font-size: 13px;
      color: var(--text-dim);
      line-height: 1.5;
      margin-top: 16px;
      text-align: left;
    }
    .what-banner strong { color: var(--text); font-weight: 600; }

    /* â”€â”€â”€ PRESET SELECT â”€â”€â”€ */
    .select-wrap { position: relative; }
    .select-wrap::after {
      content: 'â–¾';
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      pointer-events: none;
      color: var(--text-dim);
      font-size: 12px;
    }
    select {
      width: 100%;
      appearance: none;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 10px 36px 10px 14px;
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--text);
      cursor: pointer;
      transition: border-color .2s;
    }
    select:hover, select:focus { border-color: var(--border-hover); outline: none; }

    /* â”€â”€â”€ TIMING GRID â”€â”€â”€ */
    .timing-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 12px;
    }
    @media (max-width: 400px) {
      .timing-grid { grid-template-columns: repeat(2, 1fr); }
    }
    .timing-field label {
      display: block;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: .1em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 5px;
    }
    .timing-field input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 8px;
      font-family: var(--font-display);
      font-size: 22px;
      text-align: center;
      color: var(--text);
      transition: border-color .2s;
    }
    .timing-field input:focus { outline: none; border-color: var(--accent); }

    /* â”€â”€â”€ DURATION â”€â”€â”€ */
    .dur-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 12px;
    }
    .chip {
      padding: 6px 14px;
      border-radius: 999px;
      background: var(--surface2);
      border: 1px solid var(--border);
      font-size: 12px;
      font-weight: 700;
      color: var(--text-dim);
      cursor: pointer;
      transition: all .15s;
    }
    .chip:hover { border-color: var(--border-hover); color: var(--text); }
    .chip.active {
      background: var(--accent-dim);
      border-color: rgba(120,240,177,.25);
      color: var(--accent);
    }
    .range-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 12px;
    }
    .range-row span { font-size: 11px; color: var(--text-muted); font-weight: 700; min-width: 32px; }
    input[type=range] { flex: 1; accent-color: var(--accent); cursor: pointer; }
    .dur-badge {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 4px 12px;
      font-size: 13px;
      font-weight: 700;
      color: var(--text);
      min-width: 42px;
      text-align: center;
    }

    /* â”€â”€â”€ SOUND CARD â”€â”€â”€ */
    .sound-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin-bottom: 14px;
    }
    .sound-option { position: relative; }
    .sound-option input[type=radio] { position: absolute; opacity: 0; width: 0; height: 0; }
    .sound-option label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      padding: 12px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      cursor: pointer;
      transition: all .15s;
    }
    .sound-option input:checked + label {
      background: var(--accent-dim);
      border-color: rgba(120,240,177,.3);
    }
    .sound-option label:hover { border-color: var(--border-hover); }
    .sound-name { font-size: 13px; font-weight: 600; color: var(--text); }
    .sound-hz { font-size: 11px; font-weight: 700; color: var(--accent); letter-spacing: .05em; }
    .sound-desc { font-size: 11px; color: var(--text-dim); line-height: 1.3; margin-top: 2px; }
    .sound-none label { flex-direction: row; align-items: center; gap: 8px; }

    .vol-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
    }
    .vol-label {
      font-size: 11px;
      color: var(--text-muted);
      font-weight: 700;
      letter-spacing: .08em;
      text-transform: uppercase;
      white-space: nowrap;
    }
    .vol-badge { font-size: 12px; font-weight: 700; color: var(--text-dim); min-width: 48px; text-align: right; }

    .sound-status {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: .04em;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-muted);
      margin-left: auto;
    }
    .sound-status.playing {
      background: rgba(120,240,177,.08);
      border-color: rgba(120,240,177,.2);
      color: var(--accent);
    }
    .sound-status .pulse-dot { width: 5px; height: 5px; border-radius: 50%; background: currentColor; }
    .sound-status.playing .pulse-dot { animation: pulse-dot 1s ease-in-out infinite; }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: .4; transform: scale(.7); }
    }
    .card-title-row { display: flex; align-items: center; margin-bottom: 16px; }
    .card-title-row .card-title { margin-bottom: 0; }
    .headphones-tip {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 10px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .headphones-tip svg { flex-shrink: 0; }

    /* â”€â”€â”€ STREAM / CUE â”€â”€â”€ */
    .cue-display {
      font-family: var(--font-display);
      font-size: 28px;
      line-height: 1.2;
      color: var(--text);
      margin: 12px 0 16px;
      min-height: 36px;
      transition: opacity .3s;
    }
    .cue-display.fade { opacity: 0; }
    .stream-row { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
    .stream-row .select-wrap { flex: 1; min-width: 120px; }
    input[type=text].custom-stream {
      flex: 1;
      min-width: 120px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 10px 14px;
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--text);
      transition: border-color .2s;
    }
    input[type=text].custom-stream:focus { outline: none; border-color: var(--accent); }

    .btn-ghost {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 8px 14px;
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 600;
      color: var(--text-dim);
      cursor: pointer;
      transition: all .2s;
      white-space: nowrap;
    }
    .btn-ghost:hover { border-color: var(--border-hover); color: var(--text); }

    /* â”€â”€â”€ FIELD PRESENCE â”€â”€â”€ */
    .field-row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .field-count { display: flex; align-items: center; gap: 6px; margin-left: auto; font-size: 12px; color: var(--text-dim); }
    .field-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--text-muted); transition: background .3s; }
    .field-dot.online { background: var(--accent); box-shadow: 0 0 6px var(--accent-glow); }
    #fieldStatus { font-size: 12px; color: var(--text-dim); font-weight: 500; }

    /* â”€â”€â”€ GAUGE â”€â”€â”€ */
    .gauge-wrap { display: flex; align-items: center; gap: 12px; }
    .gauge-labels { display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted); font-weight: 700; letter-spacing: .08em; text-transform: uppercase; margin-top: 4px; }
    .gauge-value { font-family: var(--font-display); font-size: 28px; color: var(--text); min-width: 28px; text-align: center; line-height: 1; }
    .gauge-word { font-size: 11px; color: var(--text-dim); text-align: center; font-weight: 600; letter-spacing: .05em; min-width: 50px; }

    /* â”€â”€â”€ TEXTAREA â”€â”€â”€ */
    textarea {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--r-sm);
      padding: 12px 14px;
      font-family: var(--font-body);
      font-size: 14px;
      color: var(--text);
      resize: vertical;
      transition: border-color .2s;
      min-height: 80px;
    }
    textarea:focus { outline: none; border-color: var(--accent); }
    textarea::placeholder { color: var(--text-muted); }
    .log-actions { display: flex; gap: 8px; margin-top: 10px; }
    .btn-log {
      background: var(--accent);
      color: #0a180f;
      border: none;
      border-radius: var(--r-sm);
      padding: 10px 22px;
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all .2s;
    }
    .btn-log:hover { filter: brightness(1.05); }

    /* â”€â”€â”€ LOG ENTRIES â”€â”€â”€ */
    .log-entries { margin-top: 16px; display: flex; flex-direction: column; gap: 8px; }
    .log-entry { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--r-sm); padding: 12px 14px; }
    .log-ts { font-size: 10px; color: var(--text-muted); font-weight: 700; letter-spacing: .08em; text-transform: uppercase; margin-bottom: 4px; }
    .log-cue { font-family: var(--font-display); font-size: 15px; color: var(--text); line-height: 1.3; }
    .log-gauge { font-family: var(--font-body); font-size: 11px; color: var(--text-dim); margin-left: 8px; }
    .log-note { font-size: 13px; color: var(--text-dim); margin-top: 4px; font-style: italic; }
    .empty-state { font-size: 13px; color: var(--text-muted); text-align: center; padding: 16px 0; }
    hr { border: none; border-top: 1px solid var(--border); margin: 16px 0; }
  </style>
</head>
<body>
<div class="page">

  <!-- HEADER -->
  <div class="header">
    <div>
      <div class="logo">Co<em>here</em>nce</div>
      <div class="tagline">Heart Â· Breath Â· Field</div>
    </div>
    <button class="theme-toggle" id="themeBtn">â˜€ Light</button>
  </div>

  <!-- BREATH CARD -->
  <div class="card breath-card">
    <div class="circle-wrap">
      <div class="circle-ring"></div>
      <div class="circle-ring"></div>
      <div class="circle" id="circle">
        <div class="phase-label" id="phaseLabel">
          <span class="phase-countdown" id="phaseCountdown">Â·</span>
          <span id="phaseText">Tap to begin</span>
        </div>
      </div>
    </div>
    <div class="status-row">
      <div class="pill" id="phasePill"><span class="dot"></span> Ready</div>
      <div class="pill" id="timerPill">00:00</div>
    </div>
    <button class="btn-start" id="startBtn">
      <svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><path d="M3 2l9 5-9 5V2z"/></svg>
      Start
    </button>
    <div class="what-banner" id="whatBanner"><strong>What this does:</strong> â€”</div>
  </div>

  <!-- BREATH SETTINGS -->
  <div class="card">
    <div class="card-title">Breath Pattern</div>
    <div class="select-wrap"><select id="preset"></select></div>
    <div class="timing-grid">
      <div class="timing-field">
        <label for="inSec">In</label>
        <input id="inSec" type="number" value="4" min="1" inputmode="numeric">
      </div>
      <div class="timing-field">
        <label for="holdSec">Hold</label>
        <input id="holdSec" type="number" value="0" min="0" inputmode="numeric">
      </div>
      <div class="timing-field">
        <label for="outSec">Out</label>
        <input id="outSec" type="number" value="6" min="1" inputmode="numeric">
      </div>
      <div class="timing-field">
        <label for="durationMin">Mins</label>
        <input id="durationMin" type="number" value="1" min="1" max="60" inputmode="numeric">
      </div>
    </div>
    <div class="dur-chips" id="durationChips">
      <button class="chip" data-min="1">1m</button>
      <button class="chip" data-min="2">2m</button>
      <button class="chip" data-min="3">3m</button>
      <button class="chip" data-min="5">5m</button>
      <button class="chip" data-min="10">10m</button>
      <button class="chip" data-min="15">15m</button>
    </div>
    <div class="range-row">
      <span>Dur</span>
      <input type="range" id="durationSlider" min="1" max="20" value="1">
      <div class="dur-badge" id="durBadge">1m</div>
    </div>
  </div>

  <!-- SOUND / BINAURAL BEATS -->
  <div class="card">
    <div class="card-title-row">
      <div class="card-title">Sound &amp; Binaural Beats</div>
      <div class="sound-status" id="soundStatus"><span class="pulse-dot"></span> Off</div>
    </div>
    <div class="sound-grid">
      <div class="sound-option sound-none">
        <input type="radio" name="sound" id="snd-off" value="off" checked>
        <label for="snd-off">
          <span class="sound-name">ðŸ”‡ Silent</span>
          <span class="sound-desc">No audio â€” breathe in quiet</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-delta" value="delta">
        <label for="snd-delta">
          <span class="sound-name">Delta</span>
          <span class="sound-hz">2 Hz</span>
          <span class="sound-desc">Deep sleep, restoration, healing</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-theta" value="theta">
        <label for="snd-theta">
          <span class="sound-name">Theta</span>
          <span class="sound-hz">6 Hz</span>
          <span class="sound-desc">Meditation, creativity, intuition</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-alpha" value="alpha">
        <label for="snd-alpha">
          <span class="sound-name">Alpha</span>
          <span class="sound-hz">10 Hz</span>
          <span class="sound-desc">Calm focus, relaxed awareness</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-coherence" value="coherence">
        <label for="snd-coherence">
          <span class="sound-name">Coherence</span>
          <span class="sound-hz">0.1 Hz</span>
          <span class="sound-desc">HRV coherence â€” heart rhythm sync</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-gamma" value="gamma">
        <label for="snd-gamma">
          <span class="sound-name">Gamma</span>
          <span class="sound-hz">40 Hz</span>
          <span class="sound-desc">Focus, cognition, high alertness</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-schumann" value="schumann">
        <label for="snd-schumann">
          <span class="sound-name">Schumann</span>
          <span class="sound-hz">7.83 Hz</span>
          <span class="sound-desc">Earth resonance, grounding, balance</span>
        </label>
      </div>
    </div>
    <div class="vol-row">
      <span class="vol-label">Volume</span>
      <input type="range" id="volSlider" min="0" max="100" value="40" style="flex:1">
      <span class="vol-badge" id="volBadge">40%</span>
    </div>
    <div class="vol-row" style="margin-top:10px">
      <span class="vol-label">Carrier</span>
      <input type="range" id="carrierSlider" min="80" max="280" value="180" style="flex:1">
      <span class="vol-badge" id="carrierBadge">180 Hz</span>
    </div>
    <div class="headphones-tip">
      <svg width="13" height="13" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8">
        <path d="M3 13a7 7 0 0114 0"/>
        <rect x="1" y="13" width="4" height="5" rx="1.5"/>
        <rect x="15" y="13" width="4" height="5" rx="1.5"/>
      </svg>
      Binaural beats require stereo headphones to work properly
    </div>
  </div>

  <!-- STREAM / CUE -->
  <div class="card">
    <div class="card-title">Intention Stream</div>
    <div class="cue-display" id="cueLine">Equanimity and awareness</div>
    <div class="stream-row">
      <div class="select-wrap">
        <select id="stream">
          <option>Gentle</option>
          <option>Equanimity</option>
          <option>Joy</option>
          <option>Reverence</option>
          <option>Metta</option>
          <option>Radiance</option>
          <option>Custom</option>
        </select>
      </div>
      <input type="text" class="custom-stream" id="customStream" placeholder="Custom label">
      <button class="btn-ghost" id="newCueBtn">New cue</button>
    </div>
  </div>

  <!-- SHARED FIELD -->
  <div class="card">
    <div class="card-title">Shared Field</div>
    <div class="field-row">
      <button class="btn-ghost" id="joinBtn">Join</button>
      <button class="btn-ghost" id="leaveBtn">Leave</button>
      <span id="fieldStatus">Not joined</span>
      <div class="field-count">
        <div class="field-dot" id="fieldDot"></div>
        <span id="countPill">0</span> here
      </div>
    </div>
  </div>

  <!-- GAUGE + LOG -->
  <div class="card">
    <div class="card-title">Reflect</div>
    <div class="gauge-wrap">
      <div>
        <div class="gauge-value" id="gaugeVal">0</div>
        <div class="gauge-word" id="gaugeWord">Neutral</div>
      </div>
      <div style="flex:1">
        <input type="range" id="gauge" min="-5" max="5" value="0" style="width:100%">
        <div class="gauge-labels"><span>Tight</span><span>Open</span></div>
      </div>
    </div>
    <hr>
    <textarea id="note" rows="3" placeholder="One line noteâ€¦"></textarea>
    <div class="log-actions">
      <button class="btn-log" id="logBtn">Log Entry</button>
      <button class="btn-ghost" id="clearBtn">Clear All</button>
    </div>
    <div class="log-entries" id="logEntries">
      <div class="empty-state">No entries yet. Start breathing and log how you feel.</div>
    </div>
  </div>

</div>

<script>
(() => {
  'use strict';

  const WORKER_BASE = 'https://coherence-presence-2.lucolly999.workers.dev';
  const KEY_LOGS    = 'coh_logs_v3';
  const KEY_THEME   = 'coh_theme_v3';
  const KEY_COLOR   = 'coh_color_v3';
  const KEY_FIELD   = 'coh_field_id_v3';
  const KEY_SOUND   = 'coh_sound_v1';
  const KEY_VOL     = 'coh_vol_v1';
  const KEY_CARRIER = 'coh_carrier_v1';

  const PALETTES = [
    { c: '#78f0b1', g: 'rgba(120,240,177,.3)' },
    { c: '#7ab8ff', g: 'rgba(122,184,255,.3)' },
    { c: '#ffd36b', g: 'rgba(255,211,107,.3)' },
    { c: '#ff8ec5', g: 'rgba(255,142,197,.3)' },
    { c: '#b493ff', g: 'rgba(180,147,255,.3)' },
    { c: '#9ff0ff', g: 'rgba(159,240,255,.3)' },
    { c: '#c6ff7a', g: 'rgba(198,255,122,.3)' },
  ];

  const PRESETS = [
    { name: 'Calm (4â€“0â€“6)',      in:4, hold:0, out:6, msg:'Longer exhale activates the parasympathetic nervous system and signals safety to the body.' },
    { name: 'Focus (4â€“0â€“4)',     in:4, hold:0, out:4, msg:'Balanced inhale and exhale supports steady, calm attention without over-activation.' },
    { name: 'Downshift (3â€“0â€“6)', in:3, hold:0, out:6, msg:'Short in, long out â€” reduces arousal gently and softens mental urgency.' },
    { name: 'Ground (4â€“2â€“6)',    in:4, hold:2, out:6, msg:'Brief hold deepens interoceptive awareness; long exhale supports settling.' },
    { name: 'Energise (4â€“0â€“2)', in:4, hold:0, out:2, msg:'Short exhale can feel more activating. Use gently if feeling foggy or low.' },
    { name: 'Sleep (4â€“7â€“8)',     in:4, hold:7, out:8, msg:'Classic sleep pattern: extended hold and long exhale promote heaviness and rest.' },
    { name: 'Reset (sigh)',      in:2, hold:0, out:6, msg:'Light in, long out. Pair with a soft jaw and dropped shoulders for a full reset.' },
    { name: 'Custom',            in:4, hold:0, out:6, msg:'Build your own rhythm. If anxious: longer out. If dull: shorten out slightly.' },
  ];

  const CUES = [
    'Equanimity and awareness','Steady','Match this breath',
    'Soft eyes, soft jaw','Release','Tone first','Gentle return',
    'Reverence','Joy, unearned','Metta','Nothing to fix',
    'Ground here','Let the exhale land','Presence before response',
  ];

  const SOUND_PROFILES = {
    off:       { label: 'Silent',     beat: 0    },
    delta:     { label: 'Delta 2Hz',  beat: 2    },
    theta:     { label: 'Theta 6Hz',  beat: 6    },
    alpha:     { label: 'Alpha 10Hz', beat: 10   },
    coherence: { label: '0.1 Hz',     beat: 0.1  },
    gamma:     { label: 'Gamma 40Hz', beat: 40   },
    schumann:  { label: '7.83 Hz',    beat: 7.83 },
  };

  const el = (id) => document.getElementById(id);
  const circle         = el('circle');
  const phaseText      = el('phaseText');
  const phaseCountdown = el('phaseCountdown');
  const phasePill      = el('phasePill');
  const timerPill      = el('timerPill');
  const startBtn       = el('startBtn');
  const whatBanner     = el('whatBanner');
  const presetSel      = el('preset');
  const inSec          = el('inSec');
  const holdSec        = el('holdSec');
  const outSec         = el('outSec');
  const durationMin    = el('durationMin');
  const durationSlider = el('durationSlider');
  const durBadge       = el('durBadge');
  const chips          = Array.from(el('durationChips').querySelectorAll('.chip'));
  const cueLine        = el('cueLine');
  const newCueBtn      = el('newCueBtn');
  const joinBtn        = el('joinBtn');
  const leaveBtn       = el('leaveBtn');
  const fieldStatus    = el('fieldStatus');
  const fieldDot       = el('fieldDot');
  const countPill      = el('countPill');
  const gauge          = el('gauge');
  const gaugeVal       = el('gaugeVal');
  const gaugeWord      = el('gaugeWord');
  const note           = el('note');
  const logBtn         = el('logBtn');
  const clearBtn       = el('clearBtn');
  const logEntries     = el('logEntries');
  const themeBtn       = el('themeBtn');
  const soundStatus    = el('soundStatus');
  const volSlider      = el('volSlider');
  const volBadge       = el('volBadge');
  const carrierSlider  = el('carrierSlider');
  const carrierBadge   = el('carrierBadge');

  let running = false, phase = 'idle', phaseRemaining = 0, totalRemaining = 0, tick = null, paletteIdx = 0;
  let audioCtx = null, leftOsc = null, rightOsc = null, gainNode = null;
  let merger = null, leftGain = null, rightGain = null, audioRunning = false;

  function haptic(ms = 10) { try { navigator.vibrate && navigator.vibrate(ms); } catch(e) {} }

  function applyTheme(light) {
    document.body.classList.toggle('light', light);
    localStorage.setItem(KEY_THEME, light ? 'light' : 'dark');
    themeBtn.textContent = light ? 'â˜½ Dark' : 'â˜€ Light';
  }
  themeBtn.addEventListener('click', () => { applyTheme(!document.body.classList.contains('light')); haptic(8); });

  function applyPalette(idx) {
    const p = PALETTES[idx];
    circle.style.setProperty('--c', p.c);
    circle.style.setProperty('--cg', p.g);
    localStorage.setItem(KEY_COLOR, idx);
  }
  circle.addEventListener('click', () => {
    if (running) return;
    paletteIdx = (paletteIdx + 1) % PALETTES.length;
    applyPalette(paletteIdx);
    haptic(8);
  });

  function buildPresets() {
    PRESETS.forEach((p, i) => {
      const o = document.createElement('option');
      o.value = i; o.textContent = p.name;
      presetSel.appendChild(o);
    });
  }
  function applyPreset(idx) {
    const p = PRESETS[idx];
    inSec.value = p.in; holdSec.value = p.hold; outSec.value = p.out;
    whatBanner.innerHTML = `<strong>What this does:</strong> ${p.msg}`;
  }
  presetSel.addEventListener('change', () => { applyPreset(+presetSel.value); haptic(8); });

  function setDuration(min) {
    const m = Math.max(1, Math.min(60, +min || 1));
    durationMin.value = m; durationSlider.value = Math.min(20, m);
    durBadge.textContent = m + 'm';
    chips.forEach(c => c.classList.toggle('active', +c.dataset.min === m));
  }
  chips.forEach(c => c.addEventListener('click', () => { setDuration(c.dataset.min); haptic(6); }));
  durationSlider.addEventListener('input', () => setDuration(durationSlider.value));
  durationMin.addEventListener('input',   () => setDuration(durationMin.value));

  function getTimings() {
    return { in: Math.max(1,+inSec.value||1), hold: Math.max(0,+holdSec.value||0), out: Math.max(1,+outSec.value||1) };
  }
  function mmss(s) {
    s = Math.max(0,Math.floor(s));
    return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');
  }
  function setPhase(p, dur) {
    phase = p; phaseRemaining = dur;
    circle.classList.remove('inhale','hold','exhale','idle');
    if (p==='in') circle.classList.add('inhale');
    if (p==='hold') circle.classList.add('hold');
    if (p==='out') circle.classList.add('exhale');
    const labels = { in:'Inhale', hold:'Hold', out:'Exhale', idle:'Ready' };
    phasePill.innerHTML = `<span class="dot"></span> ${labels[p]||'Ready'}`;
    phasePill.classList.toggle('active', p !== 'idle');
    phaseText.textContent = labels[p] || '';
    haptic(8);
  }
  function advancePhase() {
    const t = getTimings();
    if (phase==='idle'||phase==='out') setPhase('in',t.in);
    else if (phase==='in') t.hold>0 ? setPhase('hold',t.hold) : setPhase('out',t.out);
    else if (phase==='hold') setPhase('out',t.out);
  }
  function startBreath() {
    totalRemaining = Math.max(1,+durationMin.value)*60;
    running = true;
    startBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><rect x="3" y="3" width="8" height="8" rx="1"/></svg> Stop';
    startBtn.classList.add('running');
    advancePhase(); startAudio();
    tick = setInterval(() => {
      totalRemaining--; timerPill.textContent = mmss(totalRemaining);
      phaseRemaining--; phaseCountdown.textContent = phaseRemaining > 0 ? phaseRemaining : '';
      if (phaseRemaining <= 0) advancePhase();
      if (totalRemaining <= 0) { stopBreath(); haptic(40); }
    }, 1000);
  }
  function stopBreath() {
    running = false; clearInterval(tick); tick = null; phase = 'idle';
    circle.classList.remove('inhale','hold','exhale'); circle.classList.add('idle');
    phasePill.innerHTML = '<span class="dot"></span> Ready'; phasePill.classList.remove('active');
    phaseText.textContent = 'Tap to begin'; phaseCountdown.textContent = 'Â·';
    timerPill.textContent = '00:00';
    startBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 14 14" fill="currentColor"><path d="M3 2l9 5-9 5V2z"/></svg> Start';
    startBtn.classList.remove('running');
    stopAudio();
    setTimeout(() => circle.classList.remove('idle'), 800);
  }
  startBtn.addEventListener('click', () => { running ? stopBreath() : startBreath(); haptic(12); });

  function getAudioCtx() {
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    return audioCtx;
  }
  function getSelectedSound() {
    const checked = document.querySelector('input[name="sound"]:checked');
    return checked ? checked.value : 'off';
  }
  function getVolume() { return (+volSlider.value) / 100; }
  function getCarrierHz() { return +carrierSlider.value; }

  function startAudio() {
    const soundKey = getSelectedSound();
    if (soundKey === 'off') return;
    const profile = SOUND_PROFILES[soundKey];
    if (!profile || profile.beat === 0) return;
    const ctx = getAudioCtx();
    if (ctx.state === 'suspended') ctx.resume();
    const carrier = getCarrierHz(), beat = profile.beat, vol = getVolume();
    merger = ctx.createChannelMerger(2);
    gainNode = ctx.createGain(); gainNode.gain.value = vol;
    leftGain = ctx.createGain(); leftGain.gain.value = 1;
    leftOsc = ctx.createOscillator(); leftOsc.type = 'sine'; leftOsc.frequency.value = carrier;
    leftOsc.connect(leftGain); leftGain.connect(merger, 0, 0);
    rightGain = ctx.createGain(); rightGain.gain.value = 1;
    rightOsc = ctx.createOscillator(); rightOsc.type = 'sine'; rightOsc.frequency.value = carrier + beat;
    rightOsc.connect(rightGain); rightGain.connect(merger, 0, 1);
    merger.connect(gainNode); gainNode.connect(ctx.destination);
    leftOsc.start(); rightOsc.start();
    audioRunning = true;
    soundStatus.classList.add('playing');
    soundStatus.innerHTML = `<span class="pulse-dot"></span> ${profile.label}`;
  }
  function stopAudio() {
    if (!audioRunning) return;
    try {
      const fadeTime = audioCtx.currentTime + 0.3;
      if (gainNode) gainNode.gain.linearRampToValueAtTime(0, fadeTime);
      setTimeout(() => {
        try { leftOsc && leftOsc.stop(); } catch(e) {}
        try { rightOsc && rightOsc.stop(); } catch(e) {}
        leftOsc = rightOsc = gainNode = merger = leftGain = rightGain = null;
      }, 350);
    } catch(e) {}
    audioRunning = false;
    soundStatus.classList.remove('playing');
    soundStatus.innerHTML = `<span class="pulse-dot"></span> Off`;
  }
  function updateAudioVolume() { if (gainNode) gainNode.gain.value = getVolume(); }
  function updateAudioCarrier() {
    if (!audioRunning) return;
    const carrier = getCarrierHz(), soundKey = getSelectedSound();
    const beat = SOUND_PROFILES[soundKey]?.beat || 0;
    if (leftOsc) leftOsc.frequency.value = carrier;
    if (rightOsc) rightOsc.frequency.value = carrier + beat;
  }

  document.querySelectorAll('input[name="sound"]').forEach(radio => {
    radio.addEventListener('change', () => {
      localStorage.setItem(KEY_SOUND, radio.value);
      if (running) { stopAudio(); startAudio(); }
    });
  });
  volSlider.addEventListener('input', () => {
    volBadge.textContent = volSlider.value + '%';
    localStorage.setItem(KEY_VOL, volSlider.value);
    updateAudioVolume();
  });
  carrierSlider.addEventListener('input', () => {
    carrierBadge.textContent = carrierSlider.value + ' Hz';
    localStorage.setItem(KEY_CARRIER, carrierSlider.value);
    updateAudioCarrier();
  });

  function randomCue() {
    const current = cueLine.textContent;
    const options = CUES.filter(c => c !== current);
    return options[Math.floor(Math.random() * options.length)];
  }
  newCueBtn.addEventListener('click', () => {
    cueLine.classList.add('fade');
    setTimeout(() => { cueLine.textContent = randomCue(); cueLine.classList.remove('fade'); }, 150);
    haptic(6);
  });

  function gaugeLabel(v) {
    if (v <= -3) return 'Tight';
    if (v >= 3)  return 'Open';
    return 'Neutral';
  }
  gauge.addEventListener('input', () => {
    const v = +gauge.value;
    gaugeVal.textContent = v > 0 ? '+' + v : v;
    gaugeWord.textContent = gaugeLabel(v);
  });

  async function api(path) {
    const res = await fetch(WORKER_BASE + path, { cache: 'no-store' });
    return res.json();
  }
  const getFieldId = () => localStorage.getItem(KEY_FIELD) || '';
  const setFieldId = (id) => id ? localStorage.setItem(KEY_FIELD, id) : localStorage.removeItem(KEY_FIELD);
  async function refreshCount() {
    try { const r = await api('/count'); if (r?.count != null) countPill.textContent = r.count; } catch(e) {}
  }
  async function joinField() {
    try {
      const r = await api('/join');
      if (r?.ok) { setFieldId(r.id); fieldStatus.textContent='Joined'; fieldDot.classList.add('online'); countPill.textContent=r.count??0; haptic([12,8,12]); }
    } catch(e) { fieldStatus.textContent = 'Error'; }
  }
  async function leaveField() {
    const id = getFieldId(); if (!id) return;
    try {
      const r = await api('/leave?id='+encodeURIComponent(id));
      if (r?.ok) { setFieldId(''); fieldStatus.textContent='Not joined'; fieldDot.classList.remove('online'); countPill.textContent=r.count??0; haptic(8); }
    } catch(e) { fieldStatus.textContent = 'Error'; }
  }
  joinBtn.addEventListener('click', joinField);
  leaveBtn.addEventListener('click', leaveField);

  function loadLogs() { try { return JSON.parse(localStorage.getItem(KEY_LOGS)||'[]'); } catch(e) { return []; } }
  function saveLogs(logs) { localStorage.setItem(KEY_LOGS, JSON.stringify(logs)); }
  function renderLogs() {
    const logs = loadLogs().slice().reverse();
    if (!logs.length) { logEntries.innerHTML='<div class="empty-state">No entries yet. Start breathing and log how you feel.</div>'; return; }
    logEntries.innerHTML = logs.map(item => {
      const safeCue  = (item.cue||'').replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
      const safeNote = (item.note||'').replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
      const gv = item.gauge;
      return `<div class="log-entry">
        <div class="log-ts">${new Date(item.ts).toLocaleString()}</div>
        <div class="log-cue">${safeCue}<span class="log-gauge">${gv>0?'+'+gv:gv} Â· ${gaugeLabel(gv)}</span></div>
        ${safeNote?`<div class="log-note">${safeNote}</div>`:''}
      </div>`;
    }).join('');
  }
  logBtn.addEventListener('click', () => {
    const logs = loadLogs();
    logs.push({ ts: new Date().toISOString(), cue: cueLine.textContent, gauge: +gauge.value, note: note.value.trim() });
    saveLogs(logs); note.value = ''; renderLogs(); haptic(8);
  });
  clearBtn.addEventListener('click', () => {
    if (!confirm('Clear all log entries?')) return;
    localStorage.removeItem(KEY_LOGS); renderLogs();
  });

  function init() {
    applyTheme(localStorage.getItem(KEY_THEME) === 'light');
    paletteIdx = (+localStorage.getItem(KEY_COLOR)||0) % PALETTES.length;
    applyPalette(paletteIdx);
    buildPresets(); applyPreset(0); setDuration(1);
    gauge.dispatchEvent(new Event('input'));
    renderLogs();
    if (getFieldId()) { fieldStatus.textContent='Joined'; fieldDot.classList.add('online'); }
    refreshCount(); setInterval(refreshCount, 5000);
    const savedSound = localStorage.getItem(KEY_SOUND) || 'off';
    const radio = document.querySelector(`input[name="sound"][value="${savedSound}"]`);
    if (radio) radio.checked = true;
    const savedVol = localStorage.getItem(KEY_VOL);
    if (savedVol !== null) { volSlider.value = savedVol; volBadge.textContent = savedVol + '%'; }
    const savedCarrier = localStorage.getItem(KEY_CARRIER);
    if (savedCarrier !== null) { carrierSlider.value = savedCarrier; carrierBadge.textContent = savedCarrier + ' Hz'; }
  }

  init();
})();
</script>
</body>
</html>
