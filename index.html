<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Coherence</title>
  <link rel="manifest" href="data:application/json,{}">
  <meta name="theme-color" content="#080f12">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='45' fill='%2378f0b1'/></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,600;1,9..40,300&display=swap" rel="stylesheet">
  <style>
  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TOKENS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  :root {
    --bg:           #080f12;
    --bg2:          #0c1419;
    --surface:      #111c24;
    --surface2:     #182530;
    --surface3:     #1f3040;
    --border:       rgba(255,255,255,.06);
    --border-h:     rgba(255,255,255,.13);
    --text:         #dde8f0;
    --text-dim:     #607587;
    --text-muted:   #334455;
    --accent:       #78f0b1;
    --accent-dim:   rgba(120,240,177,.1);
    --accent-glow:  rgba(120,240,177,.28);
    --accent2:      #7ab8ff;
    --accent2-dim:  rgba(122,184,255,.1);
    --warm:         #ffd36b;
    --rose:         #ff8ec5;
    --violet:       #b493ff;
    --font-d:       'DM Serif Display', Georgia, serif;
    --font-b:       'DM Sans', system-ui, sans-serif;
    --r:            18px;
    --r-sm:         11px;
    --transition:   .22s cubic-bezier(.4,0,.2,1);
  }
  .light {
    --bg:          #eef3f8;
    --bg2:         #e4ecf3;
    --surface:     #ffffff;
    --surface2:    #eaf0f7;
    --surface3:    #dde8f2;
    --border:      rgba(0,0,0,.07);
    --border-h:    rgba(0,0,0,.14);
    --text:        #0d1a24;
    --text-dim:    #4a6070;
    --text-muted:  #a0b8c8;
    --accent:      #1a9e6c;
    --accent-dim:  rgba(26,158,108,.1);
    --accent-glow: rgba(26,158,108,.22);
    --accent2:     #2070c0;
    --accent2-dim: rgba(32,112,192,.1);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BASE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  *, *::before, *::after { box-sizing:border-box; margin:0; padding:0; }
  html { scroll-behavior: smooth; }
  body {
    font-family: var(--font-b);
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 15px;
    line-height: 1.5;
    -webkit-font-smoothing: antialiased;
    overflow-x: hidden;
  }

  /* ambient bg */
  body::before {
    content:'';
    position:fixed; inset:0;
    background:
      radial-gradient(ellipse 80vw 60vw at 50% -10%, rgba(120,240,177,.04) 0%, transparent 70%),
      radial-gradient(ellipse 60vw 40vw at 90% 80%, rgba(122,184,255,.03) 0%, transparent 60%);
    pointer-events:none; z-index:0;
  }

  .page {
    position:relative; z-index:1;
    max-width:540px;
    margin:0 auto;
    padding:28px 18px 80px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     HEADER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .header {
    display:flex; align-items:flex-start;
    justify-content:space-between;
    margin-bottom:28px;
    transition: opacity .8s ease, transform .8s ease;
  }
  /* Orion fade: disappears after Start */
  .header.orion-fade {
    opacity: 0;
    transform: translateY(-8px);
    pointer-events: none;
  }

  .logo {
    font-family: var(--font-d);
    font-size:34px; letter-spacing:-.5px;
    color: rgba(221,232,240,.78);
    line-height:1;
    text-transform: lowercase;
  }
  .tagline {
    font-size:10px; font-weight:700;
    letter-spacing:.14em; text-transform:uppercase;
    color: var(--text-muted); margin-top:4px;
  }
  .header-controls { display:flex; gap:6px; }
  .btn-pill {
    background:none;
    border:1px solid var(--border);
    border-radius:999px;
    padding:5px 13px;
    font-size:11px; font-family:var(--font-b);
    color:var(--text-dim); cursor:pointer;
    transition: all var(--transition);
    white-space:nowrap;
  }
  .btn-pill:hover { border-color:var(--border-h); color:var(--text); }
  .btn-pill.active {
    background: var(--accent-dim);
    border-color: rgba(120,240,177,.25);
    color: var(--accent);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ONBOARDING OVERLAY
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .onboarding {
    position:fixed; inset:0; z-index:100;
    background: rgba(8,15,18,.95);
    backdrop-filter: blur(12px);
    display:flex; align-items:center; justify-content:center;
    padding:24px;
    opacity:1; transition: opacity .4s;
  }
  .onboarding.hidden { opacity:0; pointer-events:none; }
  .onboard-box {
    background: var(--surface);
    border:1px solid var(--border-h);
    border-radius:24px;
    padding:36px 32px;
    max-width:380px; width:100%;
    text-align:center;
  }
  .onboard-step { display:none; }
  .onboard-step.active { display:block; }
  .onboard-icon { font-size:42px; margin-bottom:16px; }
  .onboard-title {
    font-family: var(--font-d);
    font-size:26px; color:var(--text);
    margin-bottom:10px; line-height:1.2;
  }
  .onboard-body {
    font-size:14px; color:var(--text-dim);
    line-height:1.6; margin-bottom:24px;
  }
  .onboard-breath-demo {
    width:80px; height:80px;
    border-radius:50%;
    background: var(--accent);
    margin:0 auto 20px;
    box-shadow: 0 0 40px var(--accent-glow);
    animation: demo-breathe 5.5s ease-in-out infinite;
  }
  @keyframes demo-breathe {
    0%,100%  { transform:scale(.7);  opacity:.7; }
    50%      { transform:scale(1.15); opacity:1; }
  }
  .onboard-step-dots {
    display:flex; gap:6px; justify-content:center; margin-bottom:20px;
  }
  .step-dot {
    width:6px; height:6px; border-radius:50%;
    background: var(--text-muted); transition: background .2s;
  }
  .step-dot.active { background: var(--accent); }
  .btn-onboard-next {
    background: var(--accent); color:#0a180f;
    border:none; border-radius:999px;
    padding:12px 36px;
    font-family:var(--font-b); font-size:14px; font-weight:700;
    cursor:pointer; transition: all .2s;
    box-shadow: 0 4px 20px var(--accent-glow);
  }
  .btn-onboard-next:hover { transform:translateY(-1px); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     CARDS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .card {
    background: var(--surface);
    border:1px solid var(--border);
    border-radius:var(--r);
    padding:22px;
    margin-bottom:10px;
  }
  .card-title {
    font-size:9px; font-weight:700;
    letter-spacing:.14em; text-transform:uppercase;
    color: var(--text-muted); margin-bottom:14px;
  }
  .card-title-row {
    display:flex; align-items:center;
    margin-bottom:14px; gap:8px;
  }
  .card-title-row .card-title { margin-bottom:0; flex:1; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BREATH CIRCLE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .breath-card { text-align:center; padding:28px 22px; position:relative; overflow:hidden; }

  /* waveform canvas behind circle */
  #waveCanvas {
    position:absolute;
    bottom:0; left:0; right:0;
    width:100%; height:80px;
    opacity:.35;
    pointer-events:none;
  }

  .circle-wrap {
    position:relative;
    display:inline-flex;
    align-items:center; justify-content:center;
    margin-bottom:20px;
  }
  .circle-ring {
    position:absolute;
    border-radius:50%;
    border:1px solid var(--accent-dim);
    animation:ring-pulse 5.5s ease-in-out infinite;
  }
  .circle-ring:nth-child(1) { width:230px; height:230px; }
  .circle-ring:nth-child(2) { width:210px; height:210px; border-color:rgba(120,240,177,.05); animation-delay:.7s; }
  .circle-ring:nth-child(3) { width:250px; height:250px; border-color:rgba(120,240,177,.03); animation-delay:1.4s; }
  @keyframes ring-pulse {
    0%,100%{ transform:scale(1);   opacity:.4; }
    50%    { transform:scale(1.03); opacity:.9; }
  }

  .circle {
    position:relative;
    width:164px; height:164px;
    border-radius:50%;
    background:
      radial-gradient(circle at 33% 28%, rgba(255,255,255,.22) 0%, transparent 55%),
      var(--c, #78f0b1);
    box-shadow: 0 0 70px var(--cg, rgba(120,240,177,.25)), inset 0 1px 0 rgba(255,255,255,.3);
    transition: transform 900ms cubic-bezier(.4,0,.2,1), filter 600ms ease;
    cursor:pointer; user-select:none; z-index:1;
  }
  .circle.inhale { transform:scale(1.18); filter:brightness(1.12); }
  .circle.hold   { transform:scale(1.18); filter:brightness(1.06) saturate(1.25); }
  .circle.exhale { transform:scale(.82);  filter:brightness(.93); }

  .phase-label {
    position:absolute; inset:0;
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    pointer-events:none;
  }
  .phase-countdown {
    font-family:var(--font-d);
    font-size:28px; letter-spacing:-.5px;
    color:rgba(8,20,14,.85); line-height:1;
  }
  .phase-text {
    font-size:10px; font-weight:700;
    letter-spacing:.1em; text-transform:uppercase;
    color:rgba(8,20,14,.65); margin-top:2px;
  }

  /* coherence score ring */
  .score-ring-wrap {
    position:absolute;
    width:190px; height:190px;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    pointer-events:none; z-index:2;
  }
  #scoreRing {
    width:100%; height:100%;
    transform:rotate(-90deg);
  }
  #scoreRing .ring-track { fill:none; stroke:rgba(120,240,177,.08); stroke-width:3; }
  #scoreRing .ring-fill  { fill:none; stroke:var(--accent); stroke-width:3; stroke-linecap:round;
    stroke-dasharray:565; stroke-dashoffset:565;
    transition: stroke-dashoffset 1s ease; }

  .status-row {
    display:flex; align-items:center; justify-content:center;
    gap:8px; flex-wrap:wrap; margin-bottom:18px;
  }
  .pill {
    display:inline-flex; align-items:center; gap:4px;
    padding:5px 12px; border-radius:999px;
    background:var(--surface2); border:1px solid var(--border);
    font-size:11px; font-weight:600; color:var(--text-dim);
    transition: all .2s;
  }
  .pill.active {
    background:var(--accent-dim);
    border-color:rgba(120,240,177,.2);
    color:var(--accent);
  }
  .pill .dot { width:5px; height:5px; border-radius:50%; background:currentColor; }

  /* coherence score badge */
  .coherence-badge {
    font-family:var(--font-d);
    font-size:13px; color:var(--accent);
    display:inline-flex; align-items:center; gap:4px;
  }

  .btn-start {
    display:inline-flex; align-items:center; gap:8px;
    background:var(--accent); color:#0a180f;
    border:none; border-radius:999px;
    padding:12px 34px;
    font-family:var(--font-b); font-size:14px; font-weight:700;
    cursor:pointer; transition: all .2s;
    box-shadow: 0 4px 22px var(--accent-glow);
  }
  .btn-start:hover { transform:translateY(-1px); box-shadow:0 6px 28px var(--accent-glow); }
  .btn-start.running { background:var(--surface2); color:var(--text-dim); box-shadow:none; }

  .what-banner {
    background:var(--accent-dim);
    border:1px solid rgba(120,240,177,.1);
    border-radius:var(--r-sm);
    padding:10px 14px;
    font-size:12px; color:var(--text-dim);
    line-height:1.55; margin-top:14px; text-align:left;
  }
  .what-banner strong { color:var(--text); font-weight:600; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SESSION SUMMARY MODAL
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .summary-modal {
    position:fixed; inset:0; z-index:90;
    background:rgba(8,15,18,.88);
    backdrop-filter:blur(10px);
    display:flex; align-items:center; justify-content:center;
    padding:24px;
    opacity:0; pointer-events:none;
    transition: opacity .35s;
  }
  .summary-modal.visible { opacity:1; pointer-events:all; }
  .summary-box {
    background:var(--surface);
    border:1px solid var(--border-h);
    border-radius:24px;
    padding:32px 28px;
    max-width:380px; width:100%;
    text-align:center;
  }
  .summary-title {
    font-family:var(--font-d);
    font-size:28px; color:var(--text); margin-bottom:6px;
  }
  .summary-subtitle { font-size:13px; color:var(--text-dim); margin-bottom:24px; }
  .summary-grid {
    display:grid; grid-template-columns:1fr 1fr;
    gap:10px; margin-bottom:22px;
  }
  .summary-stat {
    background:var(--surface2);
    border:1px solid var(--border);
    border-radius:var(--r-sm);
    padding:14px 10px;
  }
  .summary-stat-val {
    font-family:var(--font-d);
    font-size:26px; color:var(--text); line-height:1;
  }
  .summary-stat-val.good { color:var(--accent); }
  .summary-stat-label {
    font-size:10px; font-weight:700;
    letter-spacing:.1em; text-transform:uppercase;
    color:var(--text-muted); margin-top:4px;
  }
  .summary-suggestion {
    background:var(--accent-dim);
    border:1px solid rgba(120,240,177,.12);
    border-radius:var(--r-sm);
    padding:12px 14px;
    font-size:13px; color:var(--text-dim);
    line-height:1.5; margin-bottom:20px; text-align:left;
  }
  .summary-suggestion strong { color:var(--text); }
  .btn-summary-close {
    background:var(--accent); color:#0a180f;
    border:none; border-radius:999px;
    padding:11px 32px;
    font-family:var(--font-b); font-size:13px; font-weight:700;
    cursor:pointer; transition:.2s;
    box-shadow:0 4px 18px var(--accent-glow);
  }
  .btn-summary-close:hover { transform:translateY(-1px); }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     COHERENCE MODE BANNER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .coherence-mode-banner {
    background: linear-gradient(135deg, rgba(120,240,177,.08), rgba(122,184,255,.06));
    border:1px solid rgba(120,240,177,.18);
    border-radius:var(--r-sm);
    padding:10px 14px;
    font-size:12px; color:var(--text-dim);
    margin-bottom:10px; display:none;
    align-items:center; gap:8px;
  }
  .coherence-mode-banner.visible { display:flex; }
  .coherence-mode-banner strong { color:var(--accent); }
  .coherence-pulse {
    width:8px; height:8px; border-radius:50%;
    background:var(--accent); flex-shrink:0;
    animation:c-pulse 1.1s ease-in-out infinite;
  }
  @keyframes c-pulse {
    0%,100%{ opacity:1; transform:scale(1); }
    50%    { opacity:.4; transform:scale(.65); }
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     BREATH SETTINGS
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .select-wrap { position:relative; }
  .select-wrap::after {
    content:'â–¾'; position:absolute;
    right:11px; top:50%; transform:translateY(-50%);
    pointer-events:none; color:var(--text-dim); font-size:11px;
  }
  select {
    width:100%; appearance:none;
    background:var(--surface2); border:1px solid var(--border);
    border-radius:var(--r-sm);
    padding:9px 34px 9px 13px;
    font-family:var(--font-b); font-size:13px;
    color:var(--text); cursor:pointer;
    transition: border-color .2s;
  }
  select:hover,select:focus { border-color:var(--border-h); outline:none; }

  .timing-grid {
    display:grid; grid-template-columns:repeat(4,1fr);
    gap:7px; margin-top:11px;
  }
  @media(max-width:400px){ .timing-grid{ grid-template-columns:repeat(2,1fr); } }
  .timing-field label {
    display:block; font-size:9px; font-weight:700;
    letter-spacing:.1em; text-transform:uppercase;
    color:var(--text-muted); margin-bottom:4px;
  }
  .timing-field input {
    width:100%; background:var(--surface2);
    border:1px solid var(--border); border-radius:var(--r-sm);
    padding:7px; font-family:var(--font-d);
    font-size:22px; text-align:center; color:var(--text);
    transition: border-color .2s;
  }
  .timing-field input:focus { outline:none; border-color:var(--accent); }

  .dur-chips { display:flex; flex-wrap:wrap; gap:5px; margin-top:11px; }
  .chip {
    padding:5px 13px; border-radius:999px;
    background:var(--surface2); border:1px solid var(--border);
    font-size:11px; font-weight:700; color:var(--text-dim);
    cursor:pointer; transition: all .15s;
  }
  .chip:hover { border-color:var(--border-h); color:var(--text); }
  .chip.active {
    background:var(--accent-dim);
    border-color:rgba(120,240,177,.25);
    color:var(--accent);
  }
  .range-row {
    display:flex; align-items:center; gap:10px; margin-top:11px;
  }
  .range-row span { font-size:10px; color:var(--text-muted); font-weight:700; min-width:28px; }
  input[type=range] { flex:1; accent-color:var(--accent); cursor:pointer; }
  .dur-badge {
    background:var(--surface2); border:1px solid var(--border);
    border-radius:999px; padding:3px 11px;
    font-size:12px; font-weight:700; color:var(--text); min-width:38px; text-align:center;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RESONANCE FINDER
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .rfinder-steps { display:none; }
  .rfinder-steps.active { display:block; }
  .rfinder-instruction {
    font-size:13px; color:var(--text-dim);
    line-height:1.6; margin-bottom:14px;
  }
  .rfinder-circle {
    width:70px; height:70px; border-radius:50%;
    background:var(--accent2);
    box-shadow:0 0 30px var(--accent2-dim);
    margin:0 auto 14px;
    transition:transform 1s ease, opacity .5s;
  }
  .rfinder-circle.inhale { transform:scale(1.2); opacity:1; }
  .rfinder-circle.exhale { transform:scale(.8);  opacity:.7; }
  .rfinder-result {
    background:var(--accent-dim);
    border:1px solid rgba(120,240,177,.15);
    border-radius:var(--r-sm);
    padding:12px 14px;
    font-size:13px; color:var(--text-dim);
    text-align:center; margin-bottom:14px;
  }
  .rfinder-result strong { color:var(--accent); font-size:15px; }
  .btn-ghost {
    background:var(--surface2); border:1px solid var(--border);
    border-radius:var(--r-sm); padding:8px 14px;
    font-family:var(--font-b); font-size:12px; font-weight:600;
    color:var(--text-dim); cursor:pointer; transition:.2s; white-space:nowrap;
  }
  .btn-ghost:hover { border-color:var(--border-h); color:var(--text); }
  .rfinder-btns { display:flex; gap:8px; flex-wrap:wrap; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SOUND
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .sound-grid {
    display:grid; grid-template-columns:1fr 1fr;
    gap:7px; margin-bottom:14px;
  }
  .sound-option { position:relative; }
  .sound-option input[type=radio] { position:absolute; opacity:0; width:0; height:0; }
  .sound-option label {
    display:flex; flex-direction:column; gap:2px;
    padding:11px 13px;
    background:var(--surface2); border:1px solid var(--border);
    border-radius:var(--r-sm); cursor:pointer; transition:.15s;
  }
  .sound-option input:checked + label {
    background:var(--accent-dim);
    border-color:rgba(120,240,177,.28);
  }
  .sound-option label:hover { border-color:var(--border-h); }
  .sound-name  { font-size:12px; font-weight:600; color:var(--text); }
  .sound-hz    { font-size:10px; font-weight:700; color:var(--accent); letter-spacing:.05em; }
  .sound-desc  { font-size:10px; color:var(--text-dim); line-height:1.3; margin-top:1px; }
  .sound-rec   { font-size:9px; color:var(--accent2); font-weight:700; letter-spacing:.06em; text-transform:uppercase; margin-top:2px; }

  .sound-status {
    display:inline-flex; align-items:center; gap:4px;
    padding:3px 9px; border-radius:999px;
    font-size:10px; font-weight:600;
    background:var(--surface2); border:1px solid var(--border);
    color:var(--text-muted);
  }
  .sound-status.playing {
    background:rgba(120,240,177,.08);
    border-color:rgba(120,240,177,.2); color:var(--accent);
  }
  .sound-status .pulse-dot { width:4px; height:4px; border-radius:50%; background:currentColor; }
  .sound-status.playing .pulse-dot { animation:pulse-dot 1s ease-in-out infinite; }
  @keyframes pulse-dot { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:.35;transform:scale(.65);} }

  .phase-tone-indicator {
    display:flex; gap:6px; align-items:center;
    font-size:11px; color:var(--text-dim); margin-top:8px;
  }
  .phase-tone-dot {
    width:28px; height:6px; border-radius:3px;
    background:var(--surface3); transition: background .3s;
  }
  .phase-tone-dot.inhale-active { background:var(--accent2); }
  .phase-tone-dot.exhale-active { background:var(--accent); }

  .vol-row { display:flex; align-items:center; gap:9px; margin-top:7px; }
  .vol-label { font-size:10px; color:var(--text-muted); font-weight:700; letter-spacing:.08em; text-transform:uppercase; white-space:nowrap; min-width:52px; }
  .vol-badge { font-size:11px; font-weight:700; color:var(--text-dim); min-width:44px; text-align:right; }
  .headphones-tip {
    font-size:10px; color:var(--text-muted);
    margin-top:10px; display:flex; align-items:center; gap:5px;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STREAK
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .streak-row { display:flex; align-items:center; gap:10px; margin-bottom:12px; }
  .streak-days { display:flex; gap:4px; flex-wrap:wrap; }
  .streak-day {
    width:22px; height:22px; border-radius:6px;
    background:var(--surface2); border:1px solid var(--border);
    display:flex; align-items:center; justify-content:center;
    font-size:9px; font-weight:700; color:var(--text-muted);
    transition: all .2s;
  }
  .streak-day.done {
    background:var(--accent-dim);
    border-color:rgba(120,240,177,.25);
    color:var(--accent);
  }
  .streak-day.today {
    border-color:var(--accent);
    box-shadow:0 0 8px var(--accent-glow);
  }
  .streak-count {
    font-family:var(--font-d);
    font-size:24px; color:var(--text);
  }
  .streak-label { font-size:10px; color:var(--text-dim); font-weight:600; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TREND CHART
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .trend-wrap { margin-top:14px; }
  .trend-label-row {
    display:flex; justify-content:space-between;
    font-size:9px; color:var(--text-muted);
    font-weight:700; letter-spacing:.08em; text-transform:uppercase;
    margin-bottom:6px;
  }
  #trendCanvas {
    width:100%; height:60px;
    display:block;
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STREAM / CUE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .cue-display {
    font-family:var(--font-d);
    font-size:26px; line-height:1.2;
    color:var(--text); margin:10px 0 14px;
    min-height:34px; transition:opacity .3s;
  }
  .cue-display.fade { opacity:0; }
  .stream-row { display:flex; gap:7px; align-items:center; flex-wrap:wrap; }
  .stream-row .select-wrap { flex:1; min-width:110px; }
  input[type=text].custom-stream {
    flex:1; min-width:110px;
    background:var(--surface2); border:1px solid var(--border);
    border-radius:var(--r-sm); padding:9px 13px;
    font-family:var(--font-b); font-size:13px; color:var(--text);
    transition: border-color .2s;
  }
  input[type=text].custom-stream:focus { outline:none; border-color:var(--accent); }

  /* mood before / after */
  .mood-row { display:flex; gap:6px; margin-top:12px; flex-wrap:wrap; }
  .mood-label { font-size:10px; color:var(--text-muted); font-weight:700; letter-spacing:.08em; text-transform:uppercase; width:100%; margin-bottom:4px; }
  .mood-btn {
    padding:5px 12px; border-radius:999px;
    background:var(--surface2); border:1px solid var(--border);
    font-size:12px; cursor:pointer; transition:.15s; color:var(--text-dim);
  }
  .mood-btn:hover { border-color:var(--border-h); }
  .mood-btn.selected {
    background:var(--accent-dim);
    border-color:rgba(120,240,177,.25); color:var(--accent);
  }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FIELD PRESENCE
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .field-row { display:flex; align-items:center; gap:7px; flex-wrap:wrap; }
  .field-count { display:flex; align-items:center; gap:5px; margin-left:auto; font-size:11px; color:var(--text-dim); }
  .field-dot { width:7px; height:7px; border-radius:50%; background:var(--text-muted); transition:.3s; }
  .field-dot.online { background:var(--accent); box-shadow:0 0 6px var(--accent-glow); }
  #fieldStatus { font-size:11px; color:var(--text-dim); font-weight:500; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GAUGE + LOG
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .gauge-wrap { display:flex; align-items:center; gap:12px; }
  .gauge-labels { display:flex; justify-content:space-between; font-size:9px; color:var(--text-muted); font-weight:700; letter-spacing:.08em; text-transform:uppercase; margin-top:3px; }
  .gauge-value { font-family:var(--font-d); font-size:28px; color:var(--text); min-width:28px; text-align:center; line-height:1; }
  .gauge-word  { font-size:10px; color:var(--text-dim); text-align:center; font-weight:600; letter-spacing:.05em; min-width:48px; }
  textarea {
    width:100%; background:var(--surface2);
    border:1px solid var(--border); border-radius:var(--r-sm);
    padding:11px 13px; font-family:var(--font-b);
    font-size:13px; color:var(--text); resize:vertical;
    transition: border-color .2s; min-height:72px;
  }
  textarea:focus { outline:none; border-color:var(--accent); }
  textarea::placeholder { color:var(--text-muted); }
  .log-actions { display:flex; gap:7px; margin-top:9px; }
  .btn-log {
    background:var(--accent); color:#0a180f;
    border:none; border-radius:var(--r-sm);
    padding:9px 20px; font-family:var(--font-b);
    font-size:12px; font-weight:700; cursor:pointer; transition:.2s;
  }
  .btn-log:hover { filter:brightness(1.06); }
  .log-entries { margin-top:14px; display:flex; flex-direction:column; gap:7px; }
  .log-entry { background:var(--surface2); border:1px solid var(--border); border-radius:var(--r-sm); padding:11px 13px; }
  .log-ts { font-size:9px; color:var(--text-muted); font-weight:700; letter-spacing:.08em; text-transform:uppercase; margin-bottom:3px; }
  .log-cue { font-family:var(--font-d); font-size:14px; color:var(--text); line-height:1.3; }
  .log-gauge { font-family:var(--font-b); font-size:10px; color:var(--text-dim); margin-left:7px; }
  .log-note { font-size:12px; color:var(--text-dim); margin-top:3px; font-style:italic; }
  .log-mood-delta { font-size:10px; color:var(--accent); margin-top:3px; font-weight:600; }
  .empty-state { font-size:12px; color:var(--text-muted); text-align:center; padding:14px 0; }
  hr { border:none; border-top:1px solid var(--border); margin:14px 0; }

  /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     SUGGESTIONS (preset pairing)
  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
  .pairing-tip {
    font-size:11px; color:var(--text-dim);
    background:var(--accent2-dim);
    border:1px solid rgba(122,184,255,.12);
    border-radius:var(--r-sm);
    padding:8px 12px; margin-top:10px;
    line-height:1.5; display:none;
  }
  .pairing-tip.visible { display:block; }
  .pairing-tip strong { color:var(--accent2); }

  /* ambient colour shift overlay */
  #ambientOverlay {
    position:fixed; inset:0; pointer-events:none; z-index:0;
    opacity:0; transition: opacity 3s ease, background 8s ease;
  }
  </style>
</head>
<body>

<!-- AMBIENT OVERLAY -->
<div id="ambientOverlay"></div>

<!-- â•â•â•â•â•â•â•â•â•â•â• ONBOARDING â•â•â•â•â•â•â•â•â•â•â• -->
<div class="onboarding" id="onboarding">
  <div class="onboard-box">
    <div class="onboard-step-dots" id="onboardDots"></div>

    <div class="onboard-step active" data-step="0">
      <div class="onboard-icon">ğŸŒ¿</div>
      <div class="onboard-title">Welcome to Coherence</div>
      <div class="onboard-body">A science-backed breathing tool designed to bring your heart, breath and nervous system into coherence â€” the state where everything flows.</div>
    </div>

    <div class="onboard-step" data-step="1">
      <div class="onboard-icon">ğŸ’“</div>
      <div class="onboard-title">What is coherence?</div>
      <div class="onboard-body">Heart-rate variability (HRV) coherence occurs when your breathing and heart rhythm synchronise. Research links it to reduced anxiety, better focus, and deeper calm.</div>
    </div>

    <div class="onboard-step" data-step="2">
      <div class="onboard-icon">ğŸŒ¬ï¸</div>
      <div class="onboard-title">Feel one breath cycle</div>
      <div class="onboard-body">Breathe with this circle. Expand as it grows â€” release as it shrinks. This is the core rhythm.</div>
      <div class="onboard-breath-demo"></div>
    </div>

    <div class="onboard-step" data-step="3">
      <div class="onboard-icon">ğŸ§</div>
      <div class="onboard-title">Binaural sound</div>
      <div class="onboard-body">Optional binaural beats play a different frequency in each ear, nudging your brainwaves toward calm, focus or sleep. Stereo headphones required.</div>
    </div>

    <div class="onboard-step" data-step="4">
      <div class="onboard-icon">âœ¨</div>
      <div class="onboard-title">You're ready</div>
      <div class="onboard-body">Start with the default Calm preset for 5 minutes. Your coherence score will grow as you stay consistent.</div>
    </div>

    <button class="btn-onboard-next" id="onboardNext">Continue â†’</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SESSION SUMMARY â•â•â•â•â•â•â•â•â•â•â• -->
<div class="summary-modal" id="summaryModal">
  <div class="summary-box">
    <div class="summary-title">Session Complete</div>
    <div class="summary-subtitle" id="summarySubtitle">â€”</div>
    <div class="summary-grid">
      <div class="summary-stat">
        <div class="summary-stat-val" id="sumCycles">â€”</div>
        <div class="summary-stat-label">Breath Cycles</div>
      </div>
      <div class="summary-stat">
        <div class="summary-stat-val good" id="sumScore">â€”</div>
        <div class="summary-stat-label">Coherence Score</div>
      </div>
      <div class="summary-stat">
        <div class="summary-stat-val" id="sumDuration">â€”</div>
        <div class="summary-stat-label">Duration</div>
      </div>
      <div class="summary-stat">
        <div class="summary-stat-val" id="sumStreak">â€”</div>
        <div class="summary-stat-label">Day Streak</div>
      </div>
    </div>
    <div class="summary-suggestion" id="summarySuggestion"></div>
    <button class="btn-summary-close" id="summaryClose">Done</button>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• PAGE â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page">

  <!-- HEADER -->
  <div class="header" id="header">
    <div>
      <div class="logo" id="brand">field</div>
      <div class="tagline">breath Â· presence Â· stillness</div>
    </div>
    <div class="header-controls">
      <button class="btn-pill" id="coherenceModeBtn">âŸ³ Coherence Mode</button>
      <button class="btn-pill" id="themeBtn">â˜€ Light</button>
    </div>
  </div>

  <!-- COHERENCE MODE BANNER -->
  <div class="coherence-mode-banner" id="coherenceBanner">
    <div class="coherence-pulse"></div>
    <span><strong>Coherence Mode active</strong> â€” 5.5s in / 5.5s out, locked to your personal resonance frequency for maximum HRV entrainment.</span>
  </div>

  <!-- BREATH CARD -->
  <div class="card breath-card">
    <canvas id="waveCanvas"></canvas>

    <div class="circle-wrap">
      <div class="circle-ring"></div>
      <div class="circle-ring"></div>
      <div class="circle-ring"></div>

      <svg class="score-ring-wrap" id="scoreRing" viewBox="0 0 190 190">
        <circle class="ring-track" cx="95" cy="95" r="90"/>
        <circle class="ring-fill"  cx="95" cy="95" r="90" id="ringFill"/>
      </svg>

      <div class="circle" id="circle">
        <div class="phase-label">
          <span class="phase-countdown" id="phaseCountdown">Â·</span>
          <span class="phase-text" id="phaseText">Tap to begin</span>
        </div>
      </div>
    </div>

    <div class="status-row">
      <div class="pill" id="phasePill"><span class="dot"></span> Ready</div>
      <div class="pill" id="timerPill">00:00</div>
      <div class="pill" id="scorePill">
        <span class="coherence-badge">â€” %</span>
      </div>
    </div>

    <button class="btn-start" id="startBtn">
      <svg width="13" height="13" viewBox="0 0 14 14" fill="currentColor"><path d="M3 2l9 5-9 5V2z"/></svg>
      Start
    </button>

    <div class="what-banner" id="whatBanner"><strong>What this does:</strong> â€”</div>
  </div>

  <!-- BREATH SETTINGS -->
  <div class="card">
    <div class="card-title">Breath Pattern</div>
    <div class="select-wrap"><select id="preset"></select></div>
    <div class="timing-grid">
      <div class="timing-field">
        <label for="inSec">In</label>
        <input id="inSec" type="number" value="4" min="1" inputmode="numeric">
      </div>
      <div class="timing-field">
        <label for="holdSec">Hold</label>
        <input id="holdSec" type="number" value="0" min="0" inputmode="numeric">
      </div>
      <div class="timing-field">
        <label for="outSec">Out</label>
        <input id="outSec" type="number" value="6" min="1" inputmode="numeric">
      </div>
      <div class="timing-field">
        <label for="durationMin">Mins</label>
        <input id="durationMin" type="number" value="5" min="1" max="60" inputmode="numeric">
      </div>
    </div>
    <div class="dur-chips" id="durationChips">
      <button class="chip" data-min="2">2m</button>
      <button class="chip" data-min="5">5m</button>
      <button class="chip" data-min="10">10m</button>
      <button class="chip" data-min="15">15m</button>
      <button class="chip" data-min="20">20m</button>
    </div>
    <div class="range-row">
      <span>Dur</span>
      <input type="range" id="durationSlider" min="1" max="20" value="5">
      <div class="dur-badge" id="durBadge">5m</div>
    </div>
    <div class="pairing-tip" id="pairingTip"></div>
  </div>

  <!-- RESONANCE FINDER -->
  <div class="card">
    <div class="card-title-row">
      <div class="card-title">Personal Resonance Finder</div>
      <button class="btn-ghost" id="rfinderToggle">Find mine</button>
    </div>
    <div class="rfinder-steps" id="rfinderSteps">
      <div id="rfStep0">
        <div class="rfinder-instruction">Your personal resonance frequency is the breath rate at which your HRV coherence is highest â€” typically between 4.5 and 7 breaths per minute. This 2-minute test helps estimate it.</div>
        <div class="rfinder-btns">
          <button class="btn-ghost" id="rfinderStart">â–¶ Start test</button>
        </div>
      </div>
      <div id="rfStep1" style="display:none; text-align:center;">
        <div class="rfinder-instruction">Breathe naturally. Tap <strong>Comfortable</strong> when the rhythm feels effortless, <strong>Too fast</strong> or <strong>Too slow</strong> if it doesn't.</div>
        <div class="rfinder-circle" id="rfinderCircle"></div>
        <div style="font-family:var(--font-d); font-size:20px; color:var(--text); margin-bottom:12px;" id="rfinderRate">5.5 breaths/min</div>
        <div class="rfinder-btns" style="justify-content:center;">
          <button class="btn-ghost" id="rfTooSlow">â† Too slow</button>
          <button class="btn-ghost" id="rfComfy" style="background:var(--accent-dim); border-color:rgba(120,240,177,.25); color:var(--accent);">âœ“ Comfortable</button>
          <button class="btn-ghost" id="rfTooFast">Too fast â†’</button>
        </div>
      </div>
      <div id="rfStep2" style="display:none; text-align:center;">
        <div class="rfinder-result">
          Your estimated resonance frequency is <strong id="rfinderResultHz">â€”</strong><br>
          <span style="font-size:11px; color:var(--text-muted);">Applied to your next session</span>
        </div>
        <div class="rfinder-btns" style="justify-content:center;">
          <button class="btn-ghost" id="rfApply" style="background:var(--accent-dim); border-color:rgba(120,240,177,.25); color:var(--accent);">Apply to session</button>
          <button class="btn-ghost" id="rfRedo">Redo test</button>
        </div>
      </div>
    </div>
  </div>

  <!-- SOUND / BINAURAL BEATS -->
  <div class="card">
    <div class="card-title-row">
      <div class="card-title">Sound &amp; Binaural Beats</div>
      <div class="sound-status" id="soundStatus"><span class="pulse-dot"></span> Off</div>
    </div>

    <div class="sound-grid">
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-off" value="off" checked>
        <label for="snd-off">
          <span class="sound-name">ğŸ”‡ Silent</span>
          <span class="sound-desc">No audio</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-delta" value="delta">
        <label for="snd-delta">
          <span class="sound-name">Delta</span>
          <span class="sound-hz">2 Hz</span>
          <span class="sound-desc">Deep rest, healing</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-theta" value="theta">
        <label for="snd-theta">
          <span class="sound-name">Theta</span>
          <span class="sound-hz">6 Hz</span>
          <span class="sound-desc">Meditation, creativity</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-alpha" value="alpha">
        <label for="snd-alpha">
          <span class="sound-name">Alpha</span>
          <span class="sound-hz">10 Hz</span>
          <span class="sound-desc">Calm, relaxed focus</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-coherence" value="coherence">
        <label for="snd-coherence">
          <span class="sound-name">Coherence</span>
          <span class="sound-hz">0.1 Hz</span>
          <span class="sound-desc">HRV heart-rhythm sync</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-gamma" value="gamma">
        <label for="snd-gamma">
          <span class="sound-name">Gamma</span>
          <span class="sound-hz">40 Hz</span>
          <span class="sound-desc">Focus, alertness</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-schumann" value="schumann">
        <label for="snd-schumann">
          <span class="sound-name">Schumann</span>
          <span class="sound-hz">7.83 Hz</span>
          <span class="sound-desc">Earth resonance</span>
        </label>
      </div>
      <div class="sound-option">
        <input type="radio" name="sound" id="snd-solfeggio" value="solfeggio">
        <label for="snd-solfeggio">
          <span class="sound-name">Solfeggio</span>
          <span class="sound-hz">528 Hz</span>
          <span class="sound-desc">Transformation, repair</span>
        </label>
      </div>
    </div>

    <!-- Phase-locked tone indicator -->
    <div class="phase-tone-indicator">
      <div class="phase-tone-dot" id="inhaleToneDot"></div>
      <span id="inhaleToneLabel" style="min-width:80px">Inhale tone</span>
      <div class="phase-tone-dot" id="exhaleToneDot"></div>
      <span id="exhaleToneLabel">Exhale tone</span>
    </div>

    <div class="vol-row" style="margin-top:12px">
      <span class="vol-label">Volume</span>
      <input type="range" id="volSlider" min="0" max="100" value="35" style="flex:1">
      <span class="vol-badge" id="volBadge">35%</span>
    </div>
    <div class="vol-row" style="margin-top:8px">
      <span class="vol-label">Carrier Hz</span>
      <input type="range" id="carrierSlider" min="80" max="300" value="180" style="flex:1">
      <span class="vol-badge" id="carrierBadge">180 Hz</span>
    </div>
    <div class="headphones-tip">
      <svg width="12" height="12" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="1.8">
        <path d="M3 13a7 7 0 0114 0"/>
        <rect x="1" y="13" width="4" height="5" rx="1.5"/>
        <rect x="15" y="13" width="4" height="5" rx="1.5"/>
      </svg>
      Binaural beats require stereo headphones
    </div>
  </div>

  <!-- STREAK -->
  <div class="card">
    <div class="card-title">Practice Streak</div>
    <div class="streak-row">
      <div>
        <div class="streak-count" id="streakCount">0</div>
        <div class="streak-label">day streak</div>
      </div>
      <div class="streak-days" id="streakDays"></div>
    </div>
    <div class="trend-wrap">
      <div class="trend-label-row">
        <span>Gauge trend (last 10)</span>
        <span id="trendAvg">â€”</span>
      </div>
      <canvas id="trendCanvas"></canvas>
    </div>
  </div>

  <!-- STREAM / CUE -->
  <div class="card">
    <div class="card-title">Intention Stream</div>

    <div class="mood-label">Mood before</div>
    <div class="mood-row" id="moodBefore">
      <button class="mood-btn" data-mood="tense">ğŸ˜¤ Tense</button>
      <button class="mood-btn" data-mood="anxious">ğŸ˜Ÿ Anxious</button>
      <button class="mood-btn" data-mood="neutral">ğŸ˜ Neutral</button>
      <button class="mood-btn" data-mood="calm">ğŸ˜Œ Calm</button>
      <button class="mood-btn" data-mood="open">ğŸŒ¿ Open</button>
    </div>

    <div class="cue-display" id="cueLine">Equanimity and awareness</div>
    <div class="stream-row">
      <div class="select-wrap">
        <select id="stream">
          <option>Gentle</option>
          <option>Equanimity</option>
          <option>Joy</option>
          <option>Reverence</option>
          <option>Metta</option>
          <option>Radiance</option>
          <option>Custom</option>
        </select>
      </div>
      <input type="text" class="custom-stream" id="customStream" placeholder="Custom label">
      <button class="btn-ghost" id="newCueBtn">New cue</button>
    </div>
  </div>

  <!-- FIELD PRESENCE -->
  <div class="card">
    <div class="card-title">Field</div>
    <div class="field-row">
      <span id="fieldStatus">The field is shared.</span>
    </div>
  </div>

  <!-- GAUGE + LOG -->
  <div class="card">
    <div class="card-title">Reflect</div>
    <div class="gauge-wrap">
      <div>
        <div class="gauge-value" id="gaugeVal">0</div>
        <div class="gauge-word"  id="gaugeWord">Neutral</div>
      </div>
      <div style="flex:1">
        <input type="range" id="gauge" min="-5" max="5" value="0" style="width:100%">
        <div class="gauge-labels"><span>Tight</span><span>Open</span></div>
      </div>
    </div>

    <div class="mood-label" style="margin-top:14px;">Mood after</div>
    <div class="mood-row" id="moodAfter">
      <button class="mood-btn" data-mood="tense">ğŸ˜¤ Tense</button>
      <button class="mood-btn" data-mood="anxious">ğŸ˜Ÿ Anxious</button>
      <button class="mood-btn" data-mood="neutral">ğŸ˜ Neutral</button>
      <button class="mood-btn" data-mood="calm">ğŸ˜Œ Calm</button>
      <button class="mood-btn" data-mood="open">ğŸŒ¿ Open</button>
    </div>

    <hr>
    <textarea id="note" rows="3" placeholder="One line noteâ€¦"></textarea>
    <div class="log-actions">
      <button class="btn-log"   id="logBtn">Log Entry</button>
      <button class="btn-ghost" id="clearBtn">Clear All</button>
    </div>
    <div class="log-entries" id="logEntries">
      <div class="empty-state">No entries yet.</div>
    </div>
  </div>

</div><!-- /page -->

<script>
(() => {
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONSTANTS & CONFIG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const WORKER_BASE = 'https://coherence-presence-2.lucolly999.workers.dev';
const KEY = {
  logs: 'coh_logs_v4', theme: 'coh_theme_v4', color: 'coh_color_v4',
  field: 'coh_field_v4', sound: 'coh_sound_v4', vol: 'coh_vol_v4',
  carrier: 'coh_carrier_v4', onboard: 'coh_onboard_v4',
  streak: 'coh_streak_v4', resonance: 'coh_resonance_v4',
};

const PALETTES = [
  { c:'#78f0b1', g:'rgba(120,240,177,.28)' },
  { c:'#7ab8ff', g:'rgba(122,184,255,.28)' },
  { c:'#ffd36b', g:'rgba(255,211,107,.28)' },
  { c:'#ff8ec5', g:'rgba(255,142,197,.28)' },
  { c:'#b493ff', g:'rgba(180,147,255,.28)' },
  { c:'#9ff0ff', g:'rgba(159,240,255,.28)' },
  { c:'#c6ff7a', g:'rgba(198,255,122,.28)' },
];

const PRESETS = [
  { name:'Coherence (5.5â€“0â€“5.5)', in:5.5, hold:0, out:5.5, sound:'coherence', msg:'The gold standard for HRV coherence. 5.5 breaths/min entrains heart and brain into synchrony.' },
  { name:'Calm (4â€“0â€“6)',          in:4,   hold:0, out:6,   sound:'alpha',     msg:'Longer exhale activates the parasympathetic nervous system and signals safety to the body.' },
  { name:'Focus (4â€“0â€“4)',         in:4,   hold:0, out:4,   sound:'alpha',     msg:'Balanced inhale and exhale supports steady, calm attention without over-activation.' },
  { name:'Downshift (3â€“0â€“6)',     in:3,   hold:0, out:6,   sound:'theta',     msg:'Short in, long out â€” reduces arousal gently and softens mental urgency.' },
  { name:'Ground (4â€“2â€“6)',        in:4,   hold:2, out:6,   sound:'schumann',  msg:'Brief hold deepens interoceptive awareness; long exhale supports settling.' },
  { name:'Energise (4â€“0â€“2)',      in:4,   hold:0, out:2,   sound:'gamma',     msg:'Short exhale can feel more activating. Use gently if feeling foggy or low.' },
  { name:'Sleep (4â€“7â€“8)',         in:4,   hold:7, out:8,   sound:'delta',     msg:'Extended hold and long exhale promote heaviness and rest.' },
  { name:'Reset (sigh)',          in:2,   hold:0, out:6,   sound:'theta',     msg:'Light in, long out. Pair with a soft jaw and dropped shoulders.' },
  { name:'Custom',                in:4,   hold:0, out:6,   sound:'off',       msg:'Build your own rhythm. If anxious: longer out. If dull: shorten out slightly.' },
];

const PAIRING_TIPS = {
  delta:    'ğŸ’¤ Delta + Sleep pattern works beautifully. Consider dimming your screen.',
  theta:    'ğŸ§˜ Theta deepens meditation. Pair with Downshift or Ground for maximum effect.',
  alpha:    'ğŸ¯ Alpha + Focus or Calm pattern is the classic coherence combo.',
  coherence:'ğŸ’“ Coherence tone pairs best with the Coherence 5.5 preset.',
  gamma:    'âš¡ Gamma is activating. Best used in the morning with short sessions.',
  schumann: 'ğŸŒ Schumann + Ground is a powerful grounding combination.',
  solfeggio:'âœ¨ 528 Hz is gentle â€” works with any pattern.',
};

const SOUND_PROFILES = {
  off:       { label:'Silent',     beat:0,    inhaleHz:0,   exhaleHz:0   },
  delta:     { label:'Delta 2Hz',  beat:2,    inhaleHz:220, exhaleHz:210 },
  theta:     { label:'Theta 6Hz',  beat:6,    inhaleHz:220, exhaleHz:210 },
  alpha:     { label:'Alpha 10Hz', beat:10,   inhaleHz:240, exhaleHz:220 },
  coherence: { label:'0.1Hz Coh',  beat:0.1,  inhaleHz:528, exhaleHz:432 },
  gamma:     { label:'Gamma 40Hz', beat:40,   inhaleHz:260, exhaleHz:240 },
  schumann:  { label:'7.83Hz',     beat:7.83, inhaleHz:220, exhaleHz:200 },
  solfeggio: { label:'528Hz',      beat:0,    inhaleHz:528, exhaleHz:528 },
};

const CUES = [
  'Equanimity and awareness','Steady','Match this breath',
  'Soft eyes, soft jaw','Release','Tone first','Gentle return',
  'Reverence','Joy, unearned','Metta','Nothing to fix',
  'Ground here','Let the exhale land','Presence before response',
  'The heart knows','Open like water','No effort needed',
  'Already whole','Receive this moment','Let go of the last breath',
];

const MOOD_ORDER = ['tense','anxious','neutral','calm','open'];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM REFS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $ = id => document.getElementById(id);
const headerEl      = $('header');
const circle        = $('circle');
const phaseText     = $('phaseText');
const phaseCountdown= $('phaseCountdown');
const phasePill     = $('phasePill');
const timerPill     = $('timerPill');
const scorePill     = $('scorePill');
const startBtn      = $('startBtn');
const whatBanner    = $('whatBanner');
const presetSel     = $('preset');
const inSec         = $('inSec');
const holdSec       = $('holdSec');
const outSec        = $('outSec');
const durationMin   = $('durationMin');
const durationSlider= $('durationSlider');
const durBadge      = $('durBadge');
const chips         = Array.from($('durationChips').querySelectorAll('.chip'));
const cueLine       = $('cueLine');
const newCueBtn     = $('newCueBtn');
const gauge         = $('gauge');
const gaugeVal      = $('gaugeVal');
const gaugeWord     = $('gaugeWord');
const note          = $('note');
const logBtn        = $('logBtn');
const clearBtn      = $('clearBtn');
const logEntries    = $('logEntries');
const themeBtn      = $('themeBtn');
const soundStatus   = $('soundStatus');
const volSlider     = $('volSlider');
const volBadge      = $('volBadge');
const carrierSlider = $('carrierSlider');
const carrierBadge  = $('carrierBadge');
const pairingTip    = $('pairingTip');
const ringFill      = $('ringFill');
const waveCanvas    = $('waveCanvas');
const trendCanvas   = $('trendCanvas');
const coherenceBanner= $('coherenceBanner');
const coherenceModeBtn=$('coherenceModeBtn');
const ambientOverlay= $('ambientOverlay');
const inhaleToneDot = $('inhaleToneDot');
const exhaleToneDot = $('exhaleToneDot');
const inhaleToneLabel=$('inhaleToneLabel');
const exhaleToneLabel=$('exhaleToneLabel');
const onboarding    = $('onboarding');
const onboardNext   = $('onboardNext');
const summaryModal  = $('summaryModal');
const summaryClose  = $('summaryClose');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let running        = false;
let phase          = 'idle';
let phaseRemaining = 0;
let totalRemaining = 0;
let sessionTotal   = 0;
let tick           = null;
let paletteIdx     = 0;
let onboardStep    = 0;
let coherenceMode  = false;
let resonanceRate  = 5.5; // breaths/min â€” personal resonance
let cycleCount     = 0;
let onTimeCount    = 0;   // cycles where user didn't interrupt
let sessionStartTs = 0;
let moodBefore     = null;
let moodAfter      = null;

// Audio
let audioCtx    = null;
let leftOsc     = null;
let rightOsc    = null;
let toneOsc     = null; // phase-locked tone
let gainNode    = null;
let toneGain    = null;
let merger      = null;
let leftGain    = null;
let rightGain   = null;
let audioRunning= false;

// Waveform animation
let wavePhase    = 0;
let waveAnimId   = null;
let breathCycle  = 10; // current full cycle seconds

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ONBOARDING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildOnboardDots(total) {
  const wrap = $('onboardDots');
  wrap.innerHTML = '';
  for (let i = 0; i < total; i++) {
    const d = document.createElement('div');
    d.className = 'step-dot' + (i === 0 ? ' active' : '');
    wrap.appendChild(d);
  }
}
function showOnboard(step) {
  const steps = onboarding.querySelectorAll('.onboard-step');
  steps.forEach((s, i) => s.classList.toggle('active', i === step));
  const dots = $('onboardDots').querySelectorAll('.step-dot');
  dots.forEach((d, i) => d.classList.toggle('active', i === step));
  const isLast = step >= steps.length - 1;
  onboardNext.textContent = isLast ? 'Begin â†’' : 'Continue â†’';
}
onboardNext.addEventListener('click', () => {
  const steps = onboarding.querySelectorAll('.onboard-step');
  if (onboardStep >= steps.length - 1) {
    onboarding.classList.add('hidden');
    localStorage.setItem(KEY.onboard, '1');
  } else {
    onboardStep++;
    showOnboard(onboardStep);
  }
});
buildOnboardDots(5);
if (localStorage.getItem(KEY.onboard)) onboarding.classList.add('hidden');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HAPTIC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function haptic(ms=10) { try { navigator.vibrate && navigator.vibrate(ms); } catch(e){} }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyTheme(light) {
  document.body.classList.toggle('light', light);
  localStorage.setItem(KEY.theme, light ? 'light' : 'dark');
  themeBtn.textContent = light ? 'â˜½ Dark' : 'â˜€ Light';
}
themeBtn.addEventListener('click', () => { applyTheme(!document.body.classList.contains('light')); haptic(8); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PALETTE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyPalette(idx) {
  const p = PALETTES[idx];
  circle.style.setProperty('--c', p.c);
  circle.style.setProperty('--cg', p.g);
  localStorage.setItem(KEY.color, idx);
}
circle.addEventListener('click', () => {
  if (running) return;
  paletteIdx = (paletteIdx + 1) % PALETTES.length;
  applyPalette(paletteIdx);
  haptic(8);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRESETS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildPresets() {
  PRESETS.forEach((p, i) => {
    const o = document.createElement('option');
    o.value = i; o.textContent = p.name;
    presetSel.appendChild(o);
  });
}
function applyPreset(idx) {
  const p = PRESETS[idx];
  inSec.value   = p.in;
  holdSec.value = p.hold;
  outSec.value  = p.out;
  whatBanner.innerHTML = `<strong>What this does:</strong> ${p.msg}`;
  // auto-recommend sound
  if (p.sound && p.sound !== 'off') {
    const radio = document.querySelector(`input[name="sound"][value="${p.sound}"]`);
    if (radio) radio.checked = true;
  }
  updatePairingTip();
}
presetSel.addEventListener('change', () => { applyPreset(+presetSel.value); haptic(8); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAIRING TIPS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updatePairingTip() {
  const snd = document.querySelector('input[name="sound"]:checked')?.value;
  const tip = PAIRING_TIPS[snd];
  if (tip) {
    pairingTip.innerHTML = tip;
    pairingTip.classList.add('visible');
  } else {
    pairingTip.classList.remove('visible');
  }
}
document.querySelectorAll('input[name="sound"]').forEach(r => {
  r.addEventListener('change', () => {
    updatePairingTip();
    localStorage.setItem(KEY.sound, r.value);
    if (running) { stopAudio(); startAudio(); }
  });
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DURATION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setDuration(min) {
  const m = Math.max(1, Math.min(60, +min || 1));
  durationMin.value    = m;
  durationSlider.value = Math.min(20, m);
  durBadge.textContent = m + 'm';
  chips.forEach(c => c.classList.toggle('active', +c.dataset.min === m));
}
chips.forEach(c => c.addEventListener('click', () => { setDuration(c.dataset.min); haptic(6); }));
durationSlider.addEventListener('input', () => setDuration(durationSlider.value));
durationMin.addEventListener('input',   () => setDuration(durationMin.value));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COHERENCE MODE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
coherenceModeBtn.addEventListener('click', () => {
  coherenceMode = !coherenceMode;
  coherenceModeBtn.classList.toggle('active', coherenceMode);
  coherenceBanner.classList.toggle('visible', coherenceMode);
  if (coherenceMode) {
    const secPerBreath = 60 / resonanceRate;
    const half = +(secPerBreath / 2).toFixed(1);
    inSec.value = half; holdSec.value = 0; outSec.value = half;
    const radio = document.querySelector('input[name="sound"][value="coherence"]');
    if (radio) radio.checked = true;
    updatePairingTip();
  }
  haptic(10);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESONANCE FINDER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let rfinderActive = false;
let rfinderCurrentRate = 5.5;
let rfinderBreathTick  = null;
let rfinderPhase       = 'inhale';

$('rfinderToggle').addEventListener('click', () => {
  const steps = $('rfinderSteps');
  const isOpen = steps.classList.contains('active');
  steps.classList.toggle('active', !isOpen);
  $('rfinderToggle').textContent = isOpen ? 'Find mine' : 'Close';
});

function rfinderBreathLoop() {
  const secPerBreath = 60 / rfinderCurrentRate;
  const half = secPerBreath / 2 * 1000;
  const circ = $('rfinderCircle');
  function cycle() {
    rfinderPhase = 'inhale';
    circ.classList.add('inhale'); circ.classList.remove('exhale');
    rfinderBreathTick = setTimeout(() => {
      rfinderPhase = 'exhale';
      circ.classList.add('exhale'); circ.classList.remove('inhale');
      rfinderBreathTick = setTimeout(cycle, half);
    }, half);
  }
  cycle();
}
function rfinderStop() {
  clearTimeout(rfinderBreathTick);
  rfinderBreathTick = null;
  rfinderActive = false;
}
$('rfinderStart').addEventListener('click', () => {
  $('rfStep0').style.display = 'none';
  $('rfStep1').style.display = 'block';
  rfinderCurrentRate = 5.5;
  $('rfinderRate').textContent = rfinderCurrentRate + ' breaths/min';
  rfinderActive = true;
  rfinderBreathLoop();
});
function adjustRate(dir) {
  rfinderStop();
  rfinderCurrentRate = Math.max(4, Math.min(8, +(rfinderCurrentRate + dir * 0.5).toFixed(1)));
  $('rfinderRate').textContent = rfinderCurrentRate + ' breaths/min';
  rfinderActive = true;
  rfinderBreathLoop();
}
$('rfTooSlow').addEventListener('click', () => adjustRate(+1));
$('rfTooFast').addEventListener('click', () => adjustRate(-1));
$('rfComfy').addEventListener('click', () => {
  rfinderStop();
  resonanceRate = rfinderCurrentRate;
  localStorage.setItem(KEY.resonance, resonanceRate);
  const secPerBreath = 60 / resonanceRate;
  $('rfinderResultHz').textContent = `${resonanceRate} breaths/min (${+(secPerBreath/2).toFixed(1)}s in / ${+(secPerBreath/2).toFixed(1)}s out)`;
  $('rfStep1').style.display = 'none';
  $('rfStep2').style.display = 'block';
});
$('rfApply').addEventListener('click', () => {
  const secPerBreath = 60 / resonanceRate;
  const half = +(secPerBreath / 2).toFixed(1);
  inSec.value = half; holdSec.value = 0; outSec.value = half;
  $('rfinderSteps').classList.remove('active');
  $('rfinderToggle').textContent = 'Find mine';
  haptic(12);
});
$('rfRedo').addEventListener('click', () => {
  $('rfStep1').style.display = 'none';
  $('rfStep2').style.display = 'none';
  $('rfStep0').style.display = 'block';
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BREATH ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getTimings() {
  return {
    in:   Math.max(1,   +inSec.value   || 1),
    hold: Math.max(0,   +holdSec.value || 0),
    out:  Math.max(1,   +outSec.value  || 1),
  };
}
function mmss(s) {
  s = Math.max(0,Math.floor(s));
  return String(Math.floor(s/60)).padStart(2,'0')+':'+String(s%60).padStart(2,'0');
}
function setPhase(p, dur) {
  phase = p; phaseRemaining = dur;
  circle.classList.remove('inhale','hold','exhale');
  if (p==='in')   { circle.classList.add('inhale'); setPhaseAudio('in'); }
  if (p==='hold') { circle.classList.add('hold');   setPhaseAudio('hold'); }
  if (p==='out')  { circle.classList.add('exhale'); setPhaseAudio('out'); }
  const labels = { in:'Inhale', hold:'Hold', out:'Exhale', idle:'Ready' };
  phasePill.innerHTML = `<span class="dot"></span> ${labels[p]||'Ready'}`;
  phasePill.classList.toggle('active', p!=='idle');
  phaseText.textContent = labels[p] || '';
  updatePhaseToneUI(p);
  haptic(8);
}
function advancePhase() {
  const t = getTimings();
  if (phase==='idle'||phase==='out') { cycleCount++; setPhase('in',t.in); }
  else if (phase==='in')  t.hold>0 ? setPhase('hold',t.hold) : setPhase('out',t.out);
  else if (phase==='hold') setPhase('out',t.out);
}

function startBreath() {
  sessionTotal   = Math.max(1,+durationMin.value)*60;
  totalRemaining = sessionTotal;
  cycleCount     = 0;
  onTimeCount    = 0;
  sessionStartTs = Date.now();
  running = true;

  // Orion: fade header out once practice begins
  headerEl.classList.add('orion-fade');

  startBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 14 14" fill="currentColor"><rect x="3" y="3" width="8" height="8" rx="1"/></svg> Stop';
  startBtn.classList.add('running');
  advancePhase();
  startAudio();
  startWaveform();
  startAmbientShift();
  tick = setInterval(() => {
    totalRemaining--;
    timerPill.textContent = mmss(totalRemaining);
    phaseRemaining--;
    phaseCountdown.textContent = phaseRemaining > 0 ? phaseRemaining : '';
    if (phaseRemaining <= 0) { onTimeCount++; advancePhase(); }
    updateCoherenceScore();
    if (totalRemaining <= 0) { stopBreath(true); haptic(40); }
  }, 1000);
}

function stopBreath(completed=false) {
  running = false;
  clearInterval(tick); tick = null;
  phase = 'idle';
  circle.classList.remove('inhale','hold','exhale');
  phasePill.innerHTML = '<span class="dot"></span> Ready';
  phasePill.classList.remove('active');
  phaseText.textContent    = 'Tap to begin';
  phaseCountdown.textContent = 'Â·';
  timerPill.textContent    = '00:00';
  startBtn.innerHTML = '<svg width="13" height="13" viewBox="0 0 14 14" fill="currentColor"><path d="M3 2l9 5-9 5V2z"/></svg> Start';
  startBtn.classList.remove('running');
  stopAudio();
  stopWaveform();
  stopAmbientShift();
  updatePhaseToneUI('idle');

  // Orion: bring header back when stopped
  headerEl.classList.remove('orion-fade');

  if (completed && cycleCount >= 2) showSummary();
}

startBtn.addEventListener('click', () => { running ? stopBreath() : startBreath(); haptic(12); });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COHERENCE SCORE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getCoherenceScore() {
  if (cycleCount < 1) return 0;
  const base = Math.min(1, onTimeCount / Math.max(1, cycleCount));
  // bonus for coherence-mode / 5.5 pattern
  const t = getTimings();
  const isIdeal = Math.abs(t.in - 5.5) < 1 && Math.abs(t.out - 5.5) < 1;
  const score = Math.round((base * (isIdeal ? 100 : 85)));
  return Math.min(99, score);
}
function updateCoherenceScore() {
  const s = getCoherenceScore();
  scorePill.innerHTML = `<span class="coherence-badge">${s}%</span>`;
  // update score ring (circumference = 2Ï€*90 â‰ˆ 565)
  const offset = 565 - (565 * s / 100);
  ringFill.style.strokeDashoffset = offset;
  scorePill.classList.toggle('active', s > 50);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SESSION SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showSummary() {
  const score   = getCoherenceScore();
  const elapsed = Math.round((Date.now() - sessionStartTs) / 1000);
  const streak  = updateStreak();
  $('sumCycles').textContent   = cycleCount;
  $('sumScore').textContent    = score + '%';
  $('sumDuration').textContent = mmss(elapsed);
  $('sumStreak').textContent   = streak + ' day' + (streak !== 1 ? 's' : '');
  // suggestion
  let suggestion = '';
  if (score >= 80) suggestion = '<strong>Excellent coherence.</strong> Try extending your session by 2â€“3 minutes next time to deepen the effect.';
  else if (score >= 55) suggestion = '<strong>Good foundation.</strong> Try slowing to 5.5s in / 5.5s out next session to hit the coherence sweet spot.';
  else suggestion = '<strong>Getting started.</strong> Consistency matters more than perfection. Even 3 minutes daily rewires the nervous system over time.';
  // mood delta
  if (moodBefore && moodAfter) {
    const before = MOOD_ORDER.indexOf(moodBefore);
    const after  = MOOD_ORDER.indexOf(moodAfter);
    const delta  = after - before;
    if (delta > 0) suggestion += ` Mood shifted ${delta} step${delta>1?'s':''} toward openness. ğŸŒ¿`;
  }
  $('summarySuggestion').innerHTML = suggestion;
  const sub = `${mmss(elapsed)} Â· ${cycleCount} cycles Â· ${score}% coherence`;
  $('summarySubtitle').textContent = sub;
  summaryModal.classList.add('visible');
  haptic([12,8,20]);
}
summaryClose.addEventListener('click', () => summaryModal.classList.remove('visible'));

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STREAK
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadStreak() {
  try { return JSON.parse(localStorage.getItem(KEY.streak) || '{"days":[],"count":0}'); }
  catch(e) { return {days:[], count:0}; }
}
function updateStreak() {
  const data  = loadStreak();
  const today = new Date().toDateString();
  if (!data.days.includes(today)) {
    data.days.push(today);
    // keep only last 30
    if (data.days.length > 30) data.days = data.days.slice(-30);
    // count consecutive days
    let streak = 0;
    let d = new Date();
    while (true) {
      if (data.days.includes(d.toDateString())) { streak++; d.setDate(d.getDate()-1); }
      else break;
    }
    data.count = streak;
    localStorage.setItem(KEY.streak, JSON.stringify(data));
  }
  renderStreak(data);
  return data.count;
}
function renderStreak(data) {
  $('streakCount').textContent = data.count;
  const wrap = $('streakDays');
  wrap.innerHTML = '';
  const today = new Date().toDateString();
  // show last 14 days
  for (let i = 13; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = d.toDateString();
    const div = document.createElement('div');
    div.className = 'streak-day' +
      (data.days.includes(ds) ? ' done' : '') +
      (ds === today ? ' today' : '');
    div.textContent = d.getDate();
    wrap.appendChild(div);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TREND CHART
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function drawTrendChart() {
  const logs  = loadLogs().slice(-10);
  const canvas= trendCanvas;
  const dpr   = window.devicePixelRatio || 1;
  canvas.width  = canvas.offsetWidth  * dpr;
  canvas.height = canvas.offsetHeight * dpr;
  const ctx   = canvas.getContext('2d');
  ctx.scale(dpr, dpr);
  const W = canvas.offsetWidth, H = canvas.offsetHeight;
  ctx.clearRect(0,0,W,H);
  if (logs.length < 2) {
    ctx.fillStyle = 'var(--text-muted)';
    ctx.font = '10px DM Sans, sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('Log more entries to see trend', W/2, H/2);
    return;
  }
  const vals = logs.map(l => l.gauge);
  const mn = -5, mx = 5;
  const pts = vals.map((v,i) => ({
    x: (i / (vals.length-1)) * (W-12) + 6,
    y: H - ((v - mn) / (mx - mn)) * (H-8) - 4,
  }));
  // gradient fill
  const grad = ctx.createLinearGradient(0,0,0,H);
  grad.addColorStop(0, 'rgba(120,240,177,.25)');
  grad.addColorStop(1, 'rgba(120,240,177,0)');
  ctx.beginPath();
  ctx.moveTo(pts[0].x, H);
  pts.forEach(p => ctx.lineTo(p.x, p.y));
  ctx.lineTo(pts[pts.length-1].x, H);
  ctx.closePath();
  ctx.fillStyle = grad;
  ctx.fill();
  // line
  ctx.beginPath();
  pts.forEach((p,i) => i===0 ? ctx.moveTo(p.x,p.y) : ctx.lineTo(p.x,p.y));
  ctx.strokeStyle = '#78f0b1';
  ctx.lineWidth = 1.5;
  ctx.stroke();
  // dots
  pts.forEach(p => {
    ctx.beginPath();
    ctx.arc(p.x, p.y, 2.5, 0, Math.PI*2);
    ctx.fillStyle = '#78f0b1';
    ctx.fill();
  });
  // avg
  const avg = vals.reduce((a,b)=>a+b,0)/vals.length;
  $('trendAvg').textContent = 'avg ' + (avg>0?'+':'') + avg.toFixed(1);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WAVEFORM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function startWaveform() {
  if (waveAnimId) return;
  const ctx = waveCanvas.getContext('2d');
  function draw() {
    const dpr = window.devicePixelRatio||1;
    waveCanvas.width  = waveCanvas.offsetWidth  * dpr;
    waveCanvas.height = waveCanvas.offsetHeight * dpr;
    ctx.scale(dpr,dpr);
    const W = waveCanvas.offsetWidth, H = waveCanvas.offsetHeight;
    ctx.clearRect(0,0,W,H);
    const t = getTimings();
    breathCycle = t.in + t.hold + t.out;
    wavePhase += (2 * Math.PI) / (breathCycle * 60);
    ctx.beginPath();
    for (let x = 0; x <= W; x++) {
      const angle = wavePhase + (x / W) * Math.PI * 4;
      const y = H/2 - Math.sin(angle) * (H/2 - 4);
      x===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
    }
    const grad = ctx.createLinearGradient(0,0,W,0);
    grad.addColorStop(0,   'rgba(120,240,177,0)');
    grad.addColorStop(0.3, 'rgba(120,240,177,.5)');
    grad.addColorStop(0.7, 'rgba(122,184,255,.5)');
    grad.addColorStop(1,   'rgba(122,184,255,0)');
    ctx.strokeStyle = grad;
    ctx.lineWidth = 1.5;
    ctx.stroke();
    waveAnimId = requestAnimationFrame(draw);
  }
  draw();
}
function stopWaveform() {
  if (waveAnimId) { cancelAnimationFrame(waveAnimId); waveAnimId = null; }
  const ctx = waveCanvas.getContext('2d');
  ctx.clearRect(0,0,waveCanvas.width, waveCanvas.height);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AMBIENT COLOUR SHIFT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let ambientTimer = null;
const ambientStages = [
  'rgba(122,184,255,.04)',  // cool blue start
  'rgba(120,240,177,.05)',  // green mid
  'rgba(180,147,255,.04)',  // violet deep
  'rgba(120,240,177,.06)',  // bright green end
];
let ambientStage = 0;
function startAmbientShift() {
  ambientOverlay.style.opacity = '1';
  ambientOverlay.style.background = ambientStages[0];
  ambientTimer = setInterval(() => {
    ambientStage = (ambientStage + 1) % ambientStages.length;
    ambientOverlay.style.background = ambientStages[ambientStage];
  }, 8000);
}
function stopAmbientShift() {
  clearInterval(ambientTimer);
  ambientOverlay.style.opacity = '0';
  ambientStage = 0;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO ENGINE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getAudioCtx() {
  if (!audioCtx) audioCtx = new (window.AudioContext||window.webkitAudioContext)();
  return audioCtx;
}
function getSelectedSound() {
  return document.querySelector('input[name="sound"]:checked')?.value || 'off';
}
function getVolume()   { return (+volSlider.value) / 100; }
function getCarrierHz(){ return +carrierSlider.value; }

function startAudio() {
  const soundKey = getSelectedSound();
  if (soundKey === 'off') return;
  const profile = SOUND_PROFILES[soundKey];
  if (!profile) return;
  const ctx = getAudioCtx();
  if (ctx.state==='suspended') ctx.resume();
  const carrier = getCarrierHz();
  const beat    = profile.beat;
  const vol     = getVolume();

  gainNode = ctx.createGain(); gainNode.gain.value = vol;

  if (beat > 0) {
    // Binaural
    merger   = ctx.createChannelMerger(2);
    leftGain = ctx.createGain(); leftGain.gain.value = 1;
    leftOsc  = ctx.createOscillator(); leftOsc.type='sine'; leftOsc.frequency.value = carrier;
    leftOsc.connect(leftGain); leftGain.connect(merger, 0, 0);
    rightGain = ctx.createGain(); rightGain.gain.value = 1;
    rightOsc  = ctx.createOscillator(); rightOsc.type='sine'; rightOsc.frequency.value = carrier + beat;
    rightOsc.connect(rightGain); rightGain.connect(merger, 0, 1);
    merger.connect(gainNode);
  } else if (profile.inhaleHz > 0) {
    // Mono solfeggio or similar
    toneGain = ctx.createGain(); toneGain.gain.value = 0.3;
    toneOsc  = ctx.createOscillator(); toneOsc.type='sine'; toneOsc.frequency.value = profile.inhaleHz;
    toneOsc.connect(toneGain); toneGain.connect(gainNode);
    if (toneOsc) toneOsc.start();
  }

  gainNode.connect(ctx.destination);
  if (leftOsc)  leftOsc.start();
  if (rightOsc) rightOsc.start();

  audioRunning = true;
  soundStatus.classList.add('playing');
  soundStatus.innerHTML = `<span class="pulse-dot"></span> ${profile.label}`;
}

function stopAudio() {
  if (!audioRunning) return;
  try {
    const fadeTime = audioCtx.currentTime + 0.4;
    if (gainNode) gainNode.gain.linearRampToValueAtTime(0, fadeTime);
    setTimeout(() => {
      [leftOsc,rightOsc,toneOsc].forEach(o => { try { o&&o.stop(); } catch(e){} });
      leftOsc=rightOsc=toneOsc=gainNode=merger=leftGain=rightGain=toneGain=null;
    }, 450);
  } catch(e) {}
  audioRunning = false;
  soundStatus.classList.remove('playing');
  soundStatus.innerHTML = `<span class="pulse-dot"></span> Off`;
}

// Phase-locked tones: different tone on inhale vs exhale
function setPhaseAudio(p) {
  if (!audioRunning) return;
  const soundKey = getSelectedSound();
  const profile  = SOUND_PROFILES[soundKey];
  if (!profile || (!profile.inhaleHz && !profile.exhaleHz)) return;
  const ctx = getAudioCtx();
  if (p === 'in'  && toneOsc) toneOsc.frequency.setTargetAtTime(profile.inhaleHz, ctx.currentTime, 0.1);
  if (p === 'out' && toneOsc) toneOsc.frequency.setTargetAtTime(profile.exhaleHz, ctx.currentTime, 0.1);
  // For binaural, shift carrier slightly
  if (leftOsc && rightOsc) {
    const base = getCarrierHz();
    const shift = p==='in' ? 0 : -5;
    const beat  = profile.beat;
    leftOsc.frequency.setTargetAtTime(base + shift,         ctx.currentTime, 0.15);
    rightOsc.frequency.setTargetAtTime(base + shift + beat, ctx.currentTime, 0.15);
  }
}

function updatePhaseToneUI(p) {
  inhaleToneDot.classList.toggle('inhale-active', p==='in');
  exhaleToneDot.classList.toggle('exhale-active', p==='out');
  const snd = getSelectedSound();
  const prof = SOUND_PROFILES[snd];
  if (prof && prof.inhaleHz) {
    inhaleToneLabel.textContent = `Inhale ${prof.inhaleHz}Hz`;
    exhaleToneLabel.textContent = `Exhale ${prof.exhaleHz||prof.inhaleHz}Hz`;
  } else {
    inhaleToneLabel.textContent = 'Inhale tone';
    exhaleToneLabel.textContent = 'Exhale tone';
  }
}

function updateAudioVolume()  { if (gainNode) gainNode.gain.value = getVolume(); }
function updateAudioCarrier() {
  if (!audioRunning) return;
  const carrier  = getCarrierHz();
  const soundKey = getSelectedSound();
  const beat     = SOUND_PROFILES[soundKey]?.beat || 0;
  if (leftOsc)  leftOsc.frequency.value  = carrier;
  if (rightOsc) rightOsc.frequency.value = carrier + beat;
}

volSlider.addEventListener('input', () => {
  volBadge.textContent = volSlider.value + '%';
  localStorage.setItem(KEY.vol, volSlider.value);
  updateAudioVolume();
});
carrierSlider.addEventListener('input', () => {
  carrierBadge.textContent = carrierSlider.value + ' Hz';
  localStorage.setItem(KEY.carrier, carrierSlider.value);
  updateAudioCarrier();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MOOD PICKERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setupMoodPicker(containerId, setter) {
  const wrap = $(containerId);
  wrap.querySelectorAll('.mood-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      wrap.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      setter(btn.dataset.mood);
      haptic(6);
    });
  });
}
setupMoodPicker('moodBefore', v => { moodBefore = v; });
setupMoodPicker('moodAfter',  v => { moodAfter  = v; });

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CUES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function randomCue() {
  const cur = cueLine.textContent;
  const opts= CUES.filter(c=>c!==cur);
  return opts[Math.floor(Math.random()*opts.length)];
}
newCueBtn.addEventListener('click', () => {
  cueLine.classList.add('fade');
  setTimeout(() => { cueLine.textContent=randomCue(); cueLine.classList.remove('fade'); }, 150);
  haptic(6);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAUGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function gaugeLabel(v) {
  if (v<=-3) return 'Tight';
  if (v>=3)  return 'Open';
  return 'Neutral';
}
gauge.addEventListener('input', () => {
  const v = +gauge.value;
  gaugeVal.textContent  = v>0 ? '+'+v : v;
  gaugeWord.textContent = gaugeLabel(v);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOG
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadLogs() { try { return JSON.parse(localStorage.getItem(KEY.logs)||'[]'); } catch(e){ return []; } }
function saveLogs(l){ localStorage.setItem(KEY.logs, JSON.stringify(l)); }
function renderLogs() {
  const logs = loadLogs().slice().reverse();
  if (!logs.length){ logEntries.innerHTML='<div class="empty-state">No entries yet. Start breathing and log how you feel.</div>'; return; }
  logEntries.innerHTML = logs.map(item => {
    const safeCue  = (item.cue ||'').replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
    const safeNote = (item.note||'').replace(/[<>&]/g,c=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[c]));
    const gv = item.gauge;
    let moodDelta = '';
    if (item.moodBefore && item.moodAfter) {
      const before = MOOD_ORDER.indexOf(item.moodBefore);
      const after  = MOOD_ORDER.indexOf(item.moodAfter);
      const delta  = after - before;
      if (delta > 0) moodDelta = `<div class="log-mood-delta">+${delta} mood shift ğŸŒ¿</div>`;
      else if (delta < 0) moodDelta = `<div class="log-mood-delta" style="color:var(--rose)">${delta} mood shift</div>`;
    }
    return `<div class="log-entry">
      <div class="log-ts">${new Date(item.ts).toLocaleString()}</div>
      <div class="log-cue">${safeCue}<span class="log-gauge">${gv>0?'+'+gv:gv} Â· ${gaugeLabel(gv)}</span></div>
      ${moodDelta}
      ${safeNote?`<div class="log-note">${safeNote}</div>`:''}
    </div>`;
  }).join('');
  drawTrendChart();
}
logBtn.addEventListener('click', () => {
  const logs = loadLogs();
  logs.push({
    ts: new Date().toISOString(),
    cue: cueLine.textContent,
    gauge: +gauge.value,
    note: note.value.trim(),
    moodBefore, moodAfter,
    score: getCoherenceScore(),
  });
  saveLogs(logs);
  note.value = ''; moodBefore = null; moodAfter = null;
  document.querySelectorAll('.mood-btn').forEach(b => b.classList.remove('selected'));
  renderLogs(); haptic(8);
});
clearBtn.addEventListener('click', () => {
  if (!confirm('Clear all log entries?')) return;
  localStorage.removeItem(KEY.logs); renderLogs();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function init() {
  applyTheme(localStorage.getItem(KEY.theme)==='light');
  paletteIdx = (+localStorage.getItem(KEY.color)||0) % PALETTES.length;
  applyPalette(paletteIdx);
  buildPresets(); applyPreset(0);
  setDuration(5);
  gauge.dispatchEvent(new Event('input'));
  renderLogs();

  // Streak
  const streakData = loadStreak();
  renderStreak(streakData);

  // Resonance
  const saved = localStorage.getItem(KEY.resonance);
  if (saved) resonanceRate = +saved;

  // Sound prefs
  const savedSound = localStorage.getItem(KEY.sound)||'off';
  const r = document.querySelector(`input[name="sound"][value="${savedSound}"]`);
  if (r) r.checked = true;
  const sv = localStorage.getItem(KEY.vol);
  if (sv) { volSlider.value=sv; volBadge.textContent=sv+'%'; }
  const sc = localStorage.getItem(KEY.carrier);
  if (sc) { carrierSlider.value=sc; carrierBadge.textContent=sc+' Hz'; }

  updatePairingTip();
  drawTrendChart();

  // Resize trend chart on resize
  window.addEventListener('resize', () => { drawTrendChart(); });
}

init();
})();
</script>
</body>
</html>
